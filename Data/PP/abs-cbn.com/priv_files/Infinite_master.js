/*!
 * ABS-CBN Corporation
 * Copyright 2015 abs-cbn.com
 * All Rights Reserved
 */
var related_articles = new Array();
var rcnt = 0;
var n=1;
var lm = $("#relatedArticleList li").length;

function init_data() {
    if (lm > 0) {
        $("#relatedArticleList li").each(function() {
            related_articles.push($(this).html());
        });
        console.log(related_articles);
        $("#next").attr("href", related_articles[rcnt]);
        rcnt++;
    } else {
        $("#next").remove();
    }
}
init_data();
// START OF INFINITE SCROLL
data_load();
$(window).on("scroll", onScroll);

// GLOBAL VARIABLE
var sticky_timer = '';

function data_load() {
	var getContent = $('.content');
	getContent.cleverInfiniteScroll({
		contentsWrapperSelector: '.section-left-panel',
		contentSelector: '.full-article',
		nextSelector: '#next',
		loadImage: 'loader.gif',
		offset: $(window).height()
	});
}

function onScroll(event){
	var items = $('.full-article');
	var article_footer = $('.article-footer');
	var current_pos = $(this).scrollTop();

	items.each(function(){
		var top = $(this).offset().top,
			bottom = top + $(this).outerHeight();

		if (current_pos >= top && current_pos <= bottom) {
			clearInterval(sticky_timer);
			sticky_timer = setTimeout(function(){
				repair_sticky(items);
			}, 100);
		}

		
	});

	/* Check the location of each desired element */
    article_footer.each( function(i){
        
        var bottom_of_object = $(this).offset().top + $(this).outerHeight();
        var bottom_of_window = $(window).scrollTop() + $(window).height();
        
        /* If the object is completely visible in the window, fade it it */
        if( bottom_of_window > bottom_of_object ){
            $(this).addClass('fadein');
			
        }
        
    }); 

}

// FOR STICKY
function repair_sticky($el) {

	// Generated by CoffeeScript 1.9.2
	(function() {
	    var reset_scroll;
	    $(function() {
	        return $("[data-sticky_column]").stick_in_parent({
	            parent: "[data-sticky_parent]"
	        });
	    });
	    reset_scroll = function() {
	        var scroller;
	        scroller = $("body,html");
	        scroller.stop(true);
	        if ($(window).scrollTop() !== 0) {
	            scroller.animate({
	                scrollTop: 0
	            }, "fast");
	        }
	        return scroller;
	    };
	    window.scroll_it = function() {
	        var max;
	        max = $(document).height() - $(window).height();
	        return reset_scroll().animate({
	            scrollTop: max
	        }, max * 3).delay(100).animate({
	            scrollTop: 0
	        }, max * 3);
	    };
	    window.scroll_it_wobble = function() {
	        var max, third;
	        max = $(document).height() - $(window).height();
	        third = Math.floor(max / 3);
	        return reset_scroll().animate({
	            scrollTop: third * 2
	        }, max * 3).delay(100).animate({
	            scrollTop: third
	        }, max * 3).delay(100).animate({
	            scrollTop: max
	        }, max * 3).delay(100).animate({
	            scrollTop: 0
	        }, max * 3);
	    };
	    $(window).on("resize", (function(_this) {
	        return function(e) {
	            return $(document.body).trigger("sticky_kit:recalc");
	        };
	    })(this));
	}).call(this);
}

////////////////////////
// Brightcove handler //
////////////////////////
var BC = (function() {
	'use strict';
	var players = [];
	function onTemplateLoad(id) {
		players.push(id);
	}
	function onTemplateReady(event) {
		var player = brightcove.api.getExperience(event.target.experience.id);
		var videoPlayer = player.getModule(brightcove.api.modules.APIModules.VIDEO_PLAYER);
		var experienceModule = player.getModule(brightcove.api.modules.APIModules.EXPERIENCE);
		if (experienceModule.experience.type == "html") {
			window.addEventListener("resize", function(event) {
				for (var i = 0; i < players.length; i++) {
					var resizeWrapper = $('.js-video-container');
					var resizeWidth = resizeWrapper.innerWidth();
					var resizeHeight = resizeWrapper.innerHeight();
					experienceModule.setSize(resizeWidth, resizeHeight)
				}
			})
		}
	}
	return {
		onTemplateLoad:onTemplateLoad,
		onTemplateReady:onTemplateReady
	};
}());

///////////
// Utils //
///////////
function getUrlParameter(sParam) {
	var sPageURL = window.location.search.substring(1);
	var sURLVariables = sPageURL.split('&');
	for (var i = 0; i < sURLVariables.length; i++) {
		var sParameterName = sURLVariables[i].split('=');
		if (sParameterName[0] == sParam) {
			return sParameterName[1];
		}
	}
}
function kFormatter(num) {
	if (num <= 999){
		return num
	} else if (num <= 999999){
		return (num/1000).toFixed(1) + ' K'
	} else if (num > 1000000){
		return (num/1000000).toFixed(1) + ' M'
	}
}
function insertParam(key, value) {
	key = encodeURI(key);
	value = encodeURI(value);

	var kvp = document.location.search.substr(1).split('&');

	if(kvp == '') {
		return '?' + key + '=' + value;
	}

	var i=kvp.length; var x; while(i--) {
		x = kvp[i].split('=');
		if (x[0]==key) {
			x[1] = value;
			kvp[i] = x.join('=');
			break;
		}
	}
	if(i<0) {kvp[kvp.length] = [key,value].join('=');}

	return '?' + kvp.join('&');
}

/*!
 * Bootstrap Modal v3.3.5 (http://getbootstrap.com)
 * Copyright 2011-2015 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */
if("undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");+function(t){"use strict";var e=t.fn.jquery.split(" ")[0].split(".");if(e[0]<2&&e[1]<9||1==e[0]&&9==e[1]&&e[2]<1)throw new Error("Bootstrap's JavaScript requires jQuery version 1.9.1 or higher")}(jQuery),+function(t){"use strict";function e(e,o){return this.each(function(){var s=t(this),n=s.data("bs.modal"),r=t.extend({},i.DEFAULTS,s.data(),"object"==typeof e&&e);n||s.data("bs.modal",n=new i(this,r)),"string"==typeof e?n[e](o):r.show&&n.show(o)})}var i=function(e,i){this.options=i,this.$body=t(document.body),this.$element=t(e),this.$dialog=this.$element.find(".modal-dialog"),this.$backdrop=null,this.isShown=null,this.originalBodyPad=null,this.scrollbarWidth=0,this.ignoreBackdropClick=!1,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,t.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};i.VERSION="3.3.5",i.TRANSITION_DURATION=300,i.BACKDROP_TRANSITION_DURATION=150,i.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},i.prototype.toggle=function(t){return this.isShown?this.hide():this.show(t)},i.prototype.show=function(e){var o=this,s=t.Event("show.bs.modal",{relatedTarget:e});this.$element.trigger(s),this.isShown||s.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.setScrollbar(),this.$body.addClass("modal-open"),this.escape(),this.resize(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',t.proxy(this.hide,this)),this.$dialog.on("mousedown.dismiss.bs.modal",function(){o.$element.one("mouseup.dismiss.bs.modal",function(e){t(e.target).is(o.$element)&&(o.ignoreBackdropClick=!0)})}),this.backdrop(function(){var s=t.support.transition&&o.$element.hasClass("fade");o.$element.parent().length||o.$element.appendTo(o.$body),o.$element.show().scrollTop(0),o.adjustDialog(),s&&o.$element[0].offsetWidth,o.$element.addClass("in"),o.enforceFocus();var n=t.Event("shown.bs.modal",{relatedTarget:e});s?o.$dialog.one("bsTransitionEnd",function(){o.$element.trigger("focus").trigger(n)}).emulateTransitionEnd(i.TRANSITION_DURATION):o.$element.trigger("focus").trigger(n)}))},i.prototype.hide=function(e){e&&e.preventDefault(),e=t.Event("hide.bs.modal"),this.$element.trigger(e),this.isShown&&!e.isDefaultPrevented()&&(this.isShown=!1,this.escape(),this.resize(),t(document).off("focusin.bs.modal"),this.$element.removeClass("in").off("click.dismiss.bs.modal").off("mouseup.dismiss.bs.modal"),this.$dialog.off("mousedown.dismiss.bs.modal"),t.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",t.proxy(this.hideModal,this)).emulateTransitionEnd(i.TRANSITION_DURATION):this.hideModal())},i.prototype.enforceFocus=function(){t(document).off("focusin.bs.modal").on("focusin.bs.modal",t.proxy(function(t){this.$element[0]===t.target||this.$element.has(t.target).length||this.$element.trigger("focus")},this))},i.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keydown.dismiss.bs.modal",t.proxy(function(t){27==t.which&&this.hide()},this)):this.isShown||this.$element.off("keydown.dismiss.bs.modal")},i.prototype.resize=function(){this.isShown?t(window).on("resize.bs.modal",t.proxy(this.handleUpdate,this)):t(window).off("resize.bs.modal")},i.prototype.hideModal=function(){var t=this;this.$element.hide(),this.backdrop(function(){t.$body.removeClass("modal-open"),t.resetAdjustments(),t.resetScrollbar(),t.$element.trigger("hidden.bs.modal")})},i.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},i.prototype.backdrop=function(e){var o=this,s=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var n=t.support.transition&&s;if(this.$backdrop=t(document.createElement("div")).addClass("modal-backdrop "+s).appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",t.proxy(function(t){return this.ignoreBackdropClick?void(this.ignoreBackdropClick=!1):void(t.target===t.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus():this.hide()))},this)),n&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!e)return;n?this.$backdrop.one("bsTransitionEnd",e).emulateTransitionEnd(i.BACKDROP_TRANSITION_DURATION):e()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var r=function(){o.removeBackdrop(),e&&e()};t.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",r).emulateTransitionEnd(i.BACKDROP_TRANSITION_DURATION):r()}else e&&e()},i.prototype.handleUpdate=function(){this.adjustDialog()},i.prototype.adjustDialog=function(){var t=this.$element[0].scrollHeight>document.documentElement.clientHeight;this.$element.css({paddingLeft:!this.bodyIsOverflowing&&t?this.scrollbarWidth:"",paddingRight:this.bodyIsOverflowing&&!t?this.scrollbarWidth:""})},i.prototype.resetAdjustments=function(){this.$element.css({paddingLeft:"",paddingRight:""})},i.prototype.checkScrollbar=function(){var t=window.innerWidth;if(!t){var e=document.documentElement.getBoundingClientRect();t=e.right-Math.abs(e.left)}this.bodyIsOverflowing=document.body.clientWidth<t,this.scrollbarWidth=this.measureScrollbar()},i.prototype.setScrollbar=function(){var t=parseInt(this.$body.css("padding-right")||0,10);this.originalBodyPad=document.body.style.paddingRight||"",this.bodyIsOverflowing&&this.$body.css("padding-right",t+this.scrollbarWidth)},i.prototype.resetScrollbar=function(){this.$body.css("padding-right",this.originalBodyPad)},i.prototype.measureScrollbar=function(){var t=document.createElement("div");t.className="modal-scrollbar-measure",this.$body.append(t);var e=t.offsetWidth-t.clientWidth;return this.$body[0].removeChild(t),e};var o=t.fn.modal;t.fn.modal=e,t.fn.modal.Constructor=i,t.fn.modal.noConflict=function(){return t.fn.modal=o,this},t(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(i){var o=t(this),s=o.attr("href"),n=t(o.attr("data-target")||s&&s.replace(/.*(?=#[^\s]+$)/,"")),r=n.data("bs.modal")?"toggle":t.extend({remote:!/#/.test(s)&&s},n.data(),o.data());o.is("a")&&i.preventDefault(),n.one("show.bs.modal",function(t){t.isDefaultPrevented()||n.one("hidden.bs.modal",function(){o.is(":visible")&&o.trigger("focus")})}),e.call(n,r,this)})}(jQuery),+function(t){"use strict";function e(){var t=document.createElement("bootstrap"),e={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var i in e)if(void 0!==t.style[i])return{end:e[i]};return!1}t.fn.emulateTransitionEnd=function(e){var i=!1,o=this;t(this).one("bsTransitionEnd",function(){i=!0});var s=function(){i||t(o).trigger(t.support.transition.end)};return setTimeout(s,e),this},t(function(){t.support.transition=e(),t.support.transition&&(t.event.special.bsTransitionEnd={bindType:t.support.transition.end,delegateType:t.support.transition.end,handle:function(e){return t(e.target).is(this)?e.handleObj.handler.apply(this,arguments):void 0}})})}(jQuery);


///////////////
// MAIN INIT //
///////////////
jQuery(document).ready(function($) {

	// cache vars
	var $window = $(window);

	// Easing
	jQuery.extend(jQuery.easing, {
		easeInExpo: function (x, t, b, c, d) {
			return (t == 0) ? b : c * Math.pow(2, 10 * (t / d - 1)) + b;
		},
		easeOutExpo: function (x, t, b, c, d) {
			return (t == d) ? b + c : c * (-Math.pow(2, -10 * t / d) + 1) + b;
		},
		easeInOutExpo: function (x, t, b, c, d) {
			if (t == 0) return b;
			if (t == d) return b + c;
			if ((t /= d / 2) < 1) return c / 2 * Math.pow(2, 10 * (t - 1)) + b;
			return c / 2 * (-Math.pow(2, -10 * --t) + 2) + b;
		},
		easeInBack: function (x, t, b, c, d, s) {
			if (s == undefined) s = 1.70158;
			return c * (t /= d) * t * ((s + 1) * t - s) + b;
		},
		easeOutBack: function (x, t, b, c, d, s) {
			if (s == undefined) s = 1.70158;
			return c * ((t = t / d - 1) * t * ((s + 1) * t + s) + 1) + b;
		},
		easeInOutBack: function (x, t, b, c, d, s) {
			if (s == undefined) s = 1.70158;
			if ((t /= d / 2) < 1) return c / 2 * (t * t * (((s *= (1.525)) + 1) * t - s)) + b;
			return c / 2 * ((t -= 2) * t * (((s *= (1.525)) + 1) * t + s) + 2) + b;
		},
		easeInElastic: function (x, t, b, c, d) {
			var s=1.70158;var p=0;var a=c;
			if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
			if (a < Math.abs(c)) { a=c; var s=p/4; }
			else var s = p/(2*Math.PI) * Math.asin (c/a);
			return -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
		},
		easeOutElastic: function (x, t, b, c, d) {
			var s=1.70158;var p=0;var a=c;
			if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
			if (a < Math.abs(c)) { a=c; var s=p/4; }
			else var s = p/(2*Math.PI) * Math.asin (c/a);
			return a*Math.pow(2,-10*t) * Math.sin( (t*d-s)*(2*Math.PI)/p ) + c + b;
		},
		easeInOutElastic: function (x, t, b, c, d) {
			var s=1.70158;var p=0;var a=c;
			if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3*1.5);
			if (a < Math.abs(c)) { a=c; var s=p/4; }
			else var s = p/(2*Math.PI) * Math.asin (c/a);
			if (t < 1) return -.5*(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
			return a*Math.pow(2,-10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )*.5 + c + b;
		}
	});

	// Social network
	var socialHolder = $('.social-holder'),
		socialHolderList = socialHolder.find('li'),
		socialHolderSlide = socialHolderList.find('.slide');

	// Social get followers/likes - Init once
	if (socialHolder.length > 0) {

		// FACEBOOK
		$.ajax({
			type: "GET",
			dataType: "jsonp",
			cache: true,
			url: "https://graph.facebook.com/abscbnNEWS",
			success: function (data) {
				var fb_count = data['likes'];
				$(socialHolder.find('span.count.fb').text(kFormatter(fb_count)));
			}
		});

		// HOVERS
		socialHolder.find('li').mouseenter(function() {
			$(this).find('.slide').stop().animate({
				'left' : 60
			},250);
		}).mouseleave(function() {
			moveleft = $(this).find('.button-holder').width();
			$(this).find('.slide').stop().animate({
				'left' : (moveleft * -1) + 60
			},250);
		}).trigger('hover');

		$window.load(function(){
			socialHolderList.each(function (){
				var moveleft = $(this).find('.button-holder').width();
				$(this).find('.slide').css({
					'left': -(moveleft) + 60
				});
			});
			socialHolderList.css('visibility','visible');
		})
	}

	/* MAIN FEATURE */
	if( $('.main-feature').length > 0 ) {
		$('.main-feature article').css({"visibility":"visible"});
		$('.main-feature article .details').each(function() {
			var that = $(this);
			if(!that.text()) {
				that.hide();
			}
		});
		$('.main-feature').slick({
			slide: 'article',
			infinite: true,
			lazyLoad: 'ondemand',
			slidesToShow: 1,
			slidesToScroll: 1,
			autoplay: true,
			autoplaySpeed: 10000,
			responsive: [{
				breakpoint: 754, //off by 14 pixel
				settings: {
					slide: 'article',
					arrows: false,
					dots: true
				}
			}]
		});
	}

	/* Colored Feature */
	if($('.carousel').length > 0) {
		$('.carousel').slick({
			slide: 'article',
			slidesToShow: 3,
			slidesToScroll: 3,
			responsive: [{
				breakpoint: 754, //off by 14 pixel
				settings: {
					slide: 'article',
					slidesToShow: 2,
					slidesToScroll: 2
				}
			},{
				breakpoint: 466, //off by 14 pixel
				settings: {
					slide: 'article',
					slidesToShow: 1,
					slidesToScroll: 1,
					centerMode: true,
					centerPadding: '30px'
				}
			}]
		});
	}

	/* slider gallery */
	// var customCarousel = (function() {
	// 	'use strict';
	// 	var $carousel = $('.photo-display'),
	// 		$carouselNav = $('.slider-nav'),
	// 		slideQuery = parseInt(getUrlParameter('pic')),
	// 		slideCount;

	// 	function paramIsValid() {
	// 		return (typeof slideQuery !== 'undefined' && slideQuery >= 1 && slideQuery <= slideCount)
	// 			? true : false;
	// 	}

	// 	function getInitialSlide() {
	// 		return paramIsValid() ? (slideQuery - 1) : 0;
	// 	}

	// 	function generatePrevArrow() {
	// 		var prevSlide = slideQuery-1;
	// 		if(prevSlide < 1) {
	// 			prevSlide = slideCount;
	// 		}
	// 		return '<a href="'+ insertParam('pic', prevSlide) +'" class="slick-prev">Previous</a>';
	// 	}

	// 	function generateNextArrow() {
	// 		var nextSlide = slideQuery+1;
	// 		if(nextSlide > slideCount) {
	// 			nextSlide = 1;
	// 		}
	// 		return '<a href="'+ insertParam('pic', nextSlide) +'" class="slick-next">Next</a>';
	// 	}

	// 	function wrapSlides() {
	// 		// for $carousel (top)
	// 		$.each($carousel.find('>'), function(index) {
	// 			index++;
	// 			if(index >= slideCount) {
	// 				index = 1;
	// 			} else {
	// 				index++; // increment again for next page
	// 			}
	// 			$(this).wrapInner('<a href="'+ insertParam('pic', index) +'"></a>');
	// 		});
	// 		// for $carouselNav (bottom)
	// 		$.each($carouselNav.find('>'), function(index) {
	// 			index++;
	// 			$(this).wrapInner('<a href="'+ insertParam('pic', index) +'"></a>');
	// 		});
	// 	}

	// 	function init() {
	// 		if($carousel.length <= 0 || $carouselNav.length <= 0) return;

	// 		// get slides count
	// 		slideCount = $carousel.find('>').length;

	// 		if(!paramIsValid()) {
	// 			slideQuery = 1;
	// 		}

	// 		// wrap each slide in <a>
	// 		wrapSlides();

	// 		$carousel.on('init', function() {
	// 			var that = $(this);
	// 			// add custom arrows for $carousel
	// 			that.prepend( generatePrevArrow() ).append( generateNextArrow() );
	// 			// scroll to view
	// 			$window.scrollTop(that.offset().top)
	// 		}).slick({
	// 			slidesToShow: 1,
	// 			slidesToScroll: 1,
	// 			arrows: false,			// we use custom arrows
	// 			accessibility: false,	// disable keyboard presses
	// 			swipe: false,			// disable swipe
	// 			draggable: false,		// disable drag
	// 			initialSlide: getInitialSlide()
	// 		});
	// 		$carouselNav.on('init', function() {
	// 			var that = $(this);
	// 			that.find('[data-slick-index='+ (slideQuery-1) +']').addClass('slick-current-custom');
	// 		}).slick({
	// 			slidesToShow: 6,
	// 			slidesToScroll: 1,
	// 			initialSlide: getInitialSlide(),
	// 			responsive: [
	// 				{ breakpoint: 754, settings: { slidesToShow: 4 } },
	// 				{ breakpoint: 466, settings: { slidesToShow: 2 } }
	// 			]
	// 		});
	// 	}

	// 	return {
	// 		init: init
	// 	};
	// }()).init();
	
	//slider gallery
	var mainCarousel = $(".photo-display");
	var navCarousel = $(".slider-nav");
	mainCarousel.slick({
		slidesToShow: 1,
		slidesToScroll: 1,
		arrows: true,
		accessibility: false,	// disable keyboard presses
		swipe: false,			// disable swipe
		draggable: false,		// disable drag
		asNavFor: '.slider-nav',
		fade: true
		// initialSlide: getInitialSlide()
	});
	navCarousel.slick({
		slidesToShow: 6,
		slidesToScroll: 1,
		asNavFor: '.photo-display',
		focusOnSelect: true,
	// initialSlide: getInitialSlide(),
		responsive: [
			{ breakpoint: 754, settings: { slidesToShow: 4 } },
			{ breakpoint: 466, settings: { slidesToShow: 2 } }
		]
	});
	function callAnalytics() {
		var dtitle = $(document).find("title").text();
		var durl = window.location.href;
		// Set history
		history.pushState(null, dtitle, durl);
		//GTM code here...
		// <!-- Google Tag Manager -->
		(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
		'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore (j,f);
		})(window,document,'script','dataLayer','GTM-57B699');
		// <!-- End Google Tag Manager -->
	}
	mainCarousel.on('afterChange', function(){
		callAnalytics();
		console.log("Test Analytics");
	});
	/* MAIN NAV DROPDOWN */
	var ddTimeout = null;
	$('nav li').has('.dropdown').hover ( function() {
		var $this = $(this);
		$this.addClass('hovered');
		ddTimeout = setTimeout( function() {
			$this.children('.dropdown').stop(true, true).slideDown(200);
		}, 200)
	}, function() {
		clearTimeout(ddTimeout);
		$(this).removeClass('hovered');
		$(this).children('.dropdown').stop(true, true).slideUp(200);
	});

	$('.plus-close-button').on('click', function(event) {
		if ($(this).find('img').hasClass('toggled')){
			$(this).find('img').removeClass('toggled');
			$(this).siblings('div').animate({
				'height' : 32
			});
		}else{
			$(this).find('img').addClass('toggled');
			$(this).siblings('div').animate({
				'height' : 165
			});
		}
		event.preventDefault();
	});

	/* COMMENT BOX */
	// $('a.btn-comment').click(function(e){
	// 	e.preventDefault();

	// 	$(this).toggleClass('active');

	// 	if( $(this).hasClass('active') ){
	// 		$('.embed-holder').addClass('visible').slideDown();
	// 	}

	// 	if( !$(this).hasClass('active') ){
	// 		$('.embed-holder').addClass('visible').slideUp();
	// 	}
	// });


	/* FILTER - UPDATES */
	/* QUERYSTRING */
	var querystring = location.search.replace( '?', '' ).split( '&' );
	var queryObj = {};

	for ( var i=0; i<querystring.length; i++ ) {
		var paramName = getUrlParameter('day') || getUrlParameter('media-type');
		var newText = $('.media-type li[data-value='+paramName+']').text() || $('.media-type li a.selected').text();
		if(!!newText) {
			$('.filtered').text(newText);
		}
	}
	$('.filtered').click(function(){
		$(this).toggleClass('clicked');
		$('.media-type').slideToggle();
	});

	$('.media-type li').click(function(){
		var inputVal = $(this).attr('data-value');
		$('input[id="media-type"]').val(inputVal);
		$("#filtering").submit();
	});

	// Youtube Fluid Wrapping
	$('iframe[src*="youtube.com"]').each(function() {
		var that = $(this);
		if( !that.parent('.video-embed').length &&
			!that.parent('.display').parent('.video-display').length) {
			that.wrap('<div class="video-embed"></div>');
		}
	});

	// Canvas
	var canvas;

	// Meme generator
	var generator = (function () {

		function backToDefault() {
			$('.canvas-container, .buttons.upload, .image-tools, .generated-preview').attr('style', '');
			$('#generate').addClass('disabled').attr('disabled', 'disabled');
		}

		function setupGenerator(canvasId) {
			// Init fabric canvas
			canvas = new fabric.Canvas(canvasId);

			var fileInput = document.getElementById('upload'),
				mFileInput = document.getElementById('mupload');

			fileInput.addEventListener('change', imageLoader, false);
			mFileInput.addEventListener('change', mImageLoader, false);

			// Submit image
			$('#meme-generator').on('submit', function() {
				// Final Data: JSON or DataURL?
				var memeJSON = JSON.stringify(canvas),
					dataURL = canvas.toDataURL("image/png"),
					// date vars
					monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
					currentdate = new Date(),
					month = monthNames[currentdate.getMonth()+1],
					date = currentdate.getDate(),
					year = currentdate.getFullYear(),
					hours = currentdate.getHours(),
					minute = currentdate.getMinutes(),
					mid = 'AM',
					timestamp;

				if(hours == 0) {
					hours = 12;
				} else if(hours > 12){
					hours = hours % 12;
					mid = 'PM';
				}

				// Concat timestamp
				timestamp = month + ' ' + date + ', ' + year + ' ' + hours + ':' + minute + ' ' + mid;

				// Show generated details
				$('.generators .generated-preview').css('display', 'table');
				$('.generators .generated-preview .timestamp').text(timestamp);

				// Reset
				$('#new').on('click', function() {
					canvas.clear();
					generator.reset();
					return false;
				});

				// Generator kept on view
				$('html, body').animate({ scrollTop: $('.generators').offset().top }, '500', 'swing');

				return false;
			});

			function imageLoader() {
				var reader = new FileReader();
				// Reset
				canvas.clear();

				reader.onload = function (event) {
					var img = new Image();

					// Defaults
					var topColor = bottomColor = '#ffffff',
						topStroke = bottomStroke = '#000000';

					img.onload = function(){
						// Reset buttons
						$('.buttons.upload').hide();
						$('.image-tools').show();
						$('#generate').removeClass('disabled').removeAttr('disabled');

						// Start drawing!
						fabric.Image.fromURL(img.src, function(img){

							var topText = $('#toptext').val(),
								topSize = $('#topsize').val(),
								bottomText = $('#bottomtext').val(),
								bottomSize = $('#bottomsize').val();

							var top = new fabric.Text(topText, {
								fontFamily: 'Impact',
								fontSize: topSize,
								textAlign: 'center',
								fill: '#ffffff',
								stroke: '#000000',
								strokeWidth: 2,
								lineCap: 'round'
							});

							var bottom = new fabric.Text(bottomText, {
								fontFamily: 'Impact',
								fontSize: bottomSize,
								textAlign: 'center',
								fill: '#ffffff',
								stroke: '#000000',
								strokeWidth: 2,
								lineCap: 'round'
							});

							// Add image to canvas
							canvas.add(img.set({
								left: 0,
								top: 0,
								scaleY: canvas.height / img.width,
								scaleX: canvas.width / img.width
							}));

							// Add text to canvas
							canvas.add(top, bottom);

							// Zoom in/out & Drag
							$('.image-tools a').on('click', function(e) {
								if (img) {
									if ($(this).hasClass('icon-zin')) {
										img.scaleX += 0.1;
										img.scaleY += 0.1;
									}
									else if ($(this).hasClass('icon-zout')) {
										img.scaleX -= 0.1;
										img.scaleY -= 0.1;
									}
									else if ($(this).hasClass('icon-fit')) {
										img.set({
											left: 0,
											top: 0,
											scaleY: canvas.height / img.width,
											scaleX: canvas.width / img.width
										});
									}
									img.setCoords();
									canvas.renderAll();
								}
								return false;
							});

							// Color change
							$('.color-picker a').on('click', function() {
								var color = $(this).data('color');
								if ($(this).hasClass('topcolor')) {
									top.set('fill', color);
									$('#topcolor').val(color);
								}
								if ($(this).hasClass('topstroke')) {
									top.set('stroke', color);
									$('#topstroke').val(color);
								}
								if ($(this).hasClass('bottomcolor')) {
									bottom.set('fill', color);
									$('#bottomcolor').val(color);
								}
								if ($(this).hasClass('bottomstroke')) {
									bottom.set('stroke', color);
									$('#bottomstroke').val(color);
								}
								canvas.renderAll();
								return false;
							});

							// Textarea on keyup
							$('textarea').on("keyup", function(e) {
								if ($(this).attr('id') === 'toptext') {
									// Get 'Enter' event
									if((e.keyCode || e.which) == 13) {
										top.set({
											text: $(this).val(),
											left: (canvas.width / 2) - (top.width / 2),
											top: 0
										});
									}
									top.set({
										text: $(this).val(),
										left: (canvas.width / 2) - (top.width / 2),
										top: 0
									});
								} else if ($(this).attr('id') === 'bottomtext') {
									// Get 'Enter' event
									if((e.keyCode || e.which) == 13) {
										bottom.set({
											text: $(this).val(),
											left: (canvas.width / 2) - (bottom.width / 2),
											top: canvas.height - bottom.height
										});
									}
									bottom.set({
										text: $(this).val(),
										left: (canvas.width / 2) - (bottom.width / 2),
										top: canvas.height - bottom.height
									});
								}
								canvas.renderAll();
							}).trigger("keyup");

							// Text size range
							$('input[type="range"]').rangeslider('destroy');
							$('input[type="range"]').rangeslider({
								polyfill: false,
								onSlide: function(position, value) {
									if (this.$element[0].id === 'topsize') {
										top.set({
											fontSize: value,
											left: (canvas.width / 2) - (top.width / 2)
										});
									}
									else if (this.$element[0].id === 'bottomsize') {
										bottom.set({
											fontSize: value,
											left: (canvas.width / 2) - (bottom.width / 2),
											top: canvas.height - bottom.height
										});
									}
									canvas.renderAll();
								}
							});
						});
					}
					img.src = reader.result;
				}
				reader.readAsDataURL(fileInput.files[0]);
			}

			function mImageLoader() {
				var reader = new FileReader();
				// Reset
				canvas.clear();
				reader.onload = function (event) {
					var img = new Image();
					// Defaults
					var topColor = bottomColor = '#ffffff',
						topStroke = bottomStroke = '#000000';

					img.onload = function(){
						// Reset buttons
						$('.buttons.upload, .image-tools').hide();
						$('#generate').removeClass('disabled').removeAttr('disabled');

						if($('.mobile-preview').length > 0) {
							$('.mobile-preview').append('<img src="'+img.src+'" />');
							$('.mobile-preview').animate({
								opacity: 1
							});
						}

						// Start drawing!
						fabric.Image.fromURL(img.src, function(img){

							var topText = $('#toptext').val(),
								topSize = $('#topsize').val(),
								bottomText = $('#bottomtext').val(),
								bottomSize = $('#bottomsize').val();

							var top = new fabric.Text(topText, {
								fontFamily: 'Impact',
								fontSize: topSize,
								textAlign: 'center',
								fill: '#ffffff',
								stroke: '#000000',
								strokeWidth: 2,
								lineCap: 'round'
							});

							var bottom = new fabric.Text(bottomText, {
								fontFamily: 'Impact',
								fontSize: bottomSize,
								textAlign: 'center',
								fill: '#ffffff',
								stroke: '#000000',
								strokeWidth: 2,
								lineCap: 'round'
							});

							// Add image to canvas
							canvas.add(img.set({
								left: 0,
								top: 0,
								scaleY: canvas.height / img.width,
								scaleX: canvas.width / img.width
							}));

							// Add text to canvas
							canvas.add(top, bottom);

							// Zoom in/out & Drag
							$('.image-tools a').on('click', function(e) {
								if (img) {
									if ($(this).hasClass('icon-zin')) {
										img.scaleX += 0.1;
										img.scaleY += 0.1;
									}
									else if ($(this).hasClass('icon-zout')) {
										img.scaleX -= 0.1;
										img.scaleY -= 0.1;
									}
									else if ($(this).hasClass('icon-fit')) {
										img.set({
											left: 0,
											top: 0,
											scaleY: canvas.height / img.width,
											scaleX: canvas.width / img.width
										});
									}
									img.setCoords();
									canvas.renderAll();
								}
								return false;
							});

							// Color change
							$('.color-picker a').on('click', function() {
								var color = $(this).data('color');
								if ($(this).hasClass('topcolor')) {
									top.set('fill', color);
									$('#topcolor').val(color);
								}
								if ($(this).hasClass('topstroke')) {
									top.set('stroke', color);
									$('#topstroke').val(color);
								}
								if ($(this).hasClass('bottomcolor')) {
									bottom.set('fill', color);
									$('#bottomcolor').val(color);
								}
								if ($(this).hasClass('bottomstroke')) {
									bottom.set('stroke', color);
									$('#bottomstroke').val(color);
								}
								canvas.renderAll();
								return false;
							});

							// Textarea on keyup
							$('textarea').on("keyup", function(e) {
								if ($(this).attr('id') === 'toptext') {
									// Get 'Enter' event
									if((e.keyCode || e.which) == 13) {
										top.set({
											text: $(this).val(),
											left: (canvas.width / 2) - (top.width / 2),
											top: 0
										});
									}
									top.set({
										text: $(this).val(),
										left: (canvas.width / 2) - (top.width / 2),
										top: 0
									});
								}
								else if ($(this).attr('id') === 'bottomtext') {
									// Get 'Enter' event
									if((e.keyCode || e.which) == 13) {
										bottom.set({
											text: $(this).val(),
											left: (canvas.width / 2) - (bottom.width / 2),
											top: canvas.height - bottom.height
										});
									}
									bottom.set({
										text: $(this).val(),
										left: (canvas.width / 2) - (bottom.width / 2),
										top: canvas.height - bottom.height
									});
								}
								canvas.renderAll();
							}).trigger("keyup");

							// Text size range
							$('input[type="range"]').rangeslider('destroy');
							$('input[type="range"]').rangeslider({
								polyfill: false,
								onSlide: function(position, value) {
									if (this.$element[0].id === 'topsize') {
										top.set({
											fontSize: value,
											left: (canvas.width / 2) - (top.width / 2)
										});
									}
									else if (this.$element[0].id === 'bottomsize') {
										bottom.set({
											fontSize: value,
											left: (canvas.width / 2) - (bottom.width / 2),
											top: canvas.height - bottom.height
										});
									}
									canvas.renderAll();
								}
							});
						});
					}
					img.src = reader.result;
				}
				reader.readAsDataURL(mFileInput.files[0]);
			}
		}

		return {
			setup: setupGenerator,
			reset: backToDefault
		};
	}());

	// Build meme generator
	if($('.generators').length > 0) {
		generator.setup('canvas');
	}

	// Range polyfill - Init once
	if($('input[type="range"]').length > 0) {
		$('input[type="range"]').rangeslider({ polyfill: false });
	}

	/*POLL*/
	$('.question-block li a').click(function(e){
		e.preventDefault();
		var that = $(this),
		value = that.attr('data-value');
		that.parent('li').siblings('li').children('a').removeClass('selected')
		.addClass('selected')
		.parents('ul.question-block').siblings('input[type="hidden"]').val(value);
	});
	$('.poll-results li .percent').each(function(){
		var value = $(this).text().replace(/[^\d]/g, "");
		$(this).siblings('div').children('.bar').css({ "width": value+'%' })
	});

	// Store Modal
	$('#storeModal').on('show.bs.modal', function (event) {
		var link = $(event.relatedTarget),
			img = link.data('image'),
			details = link.siblings('.item-details').clone(),
			modal = $(this);
		modal.find('.modal-body').empty()
			.append('<img src="'+ img +'" class="item-image">')
			.append(details)
			.find('.item-details > p:first-child').appendTo(modal.find('.item-details'));
	});


	/* BREAKPOINT DECLARATION */
	function breakpoints() {
		/* Scroll Bar hack */
		var e = window, a = 'inner';
		if (!('innerWidth' in window )) {
			a = 'client';
			e = document.documentElement || document.body;
		}
		var totalWidth = e[ a+'Width' ],
		animateEnter = function () {
			$(this).addClass('hovered');
			var bigImage = $(this).find('.details').attr('data-src');
			$(this).children('.data').prepend('<img class="big" src="'+bigImage+'">');
			$('.big').show();
		},
		animateLeave = function () {
			$(this).removeClass('hovered');
			$('.big').remove();
		};

		if ( totalWidth >= 1024 ) {
			$('.schedule-block li')
			.unbind('mouseenter mouseleave')
			.hover(animateEnter, animateLeave);
		}
		if ( totalWidth <= 1023 ) {
			$('.schedule-block li')
			.unbind('mouseenter', animateEnter)
			.unbind('mouseleave', animateLeave);
		}
	}

	$window.on('resize', function(){
		breakpoints();
	}).resize();

	$.get('http://lifestyle.abs-cbn.com/feed/', function(data) {
		var $xml = $(data);
		var LifeMeme;
		var Lits;

		LifeMeme='';
		Lits = 0;

		$xml.find("item").each(function() {
			if(Lits<=5){
				LifeMeme += '<article class="article">';
				LifeMeme +=	'<a href="'+ $(this).find("link").text() +'" target="_blank">';
				LifeMeme += '<div class="overlay"><img src="https://azuretv2devewu00sca63.blob.core.windows.net/tv2images/lifestyle_logo.png" alt="ABS-CBN Lifestyle"></div>';
				LifeMeme += '<img src="'+ $('media\\:content, content', this).attr('url') +'" alt="'+ $(this).find("title").text() +'" width="204" height="136">';
				LifeMeme += '</a>';
				LifeMeme += '<h4>'+ $(this).find("title").text() +'</h4>';
				LifeMeme += '</article>';
				Lits ++
			}
		});
		$( LifeMeme ).appendTo( $( 'section[data="lifestylefeed"]' ) );
	});

	$.get('http://sports.abs-cbn.com/feed/', function(data) {
		var $xml = $(data);
		var SportsHTML;
		var Hits;

		SportsHTML='';
		Hits = 0;

		$xml.find("item").each(function() {
			if(Hits<=5){
				SportsHTML += '<article class="article">';
				SportsHTML += '<a href="'+ $(this).find("link").text()+ '" target="_blank">';
				SportsHTML += '<div class="overlay"><img src="https://azuretv2devewu00sca63.blob.core.windows.net/tv2images/logo-sports-og.png" alt="Show Logo"></div>';
				SportsHTML +=	'<img src="'+ $(this).find("thumbimage").text() +'" alt="'+ $(this).find("title").text() +'" width="204" height="136">';
				SportsHTML +=	'</a>';
				SportsHTML +=	'<h4>'+ $(this).find("title").text() +'</h4>';
				SportsHTML += '</article>';
				Hits ++
			}
		});
		$( SportsHTML ).appendTo( $( 'section[data="sportsfeed"]' ) );
	});

	$.get('http://www.choosephilippines.com/feed', function(data) {
		var $xml = $(data);
		var ChooseHTML;
		var HitC;

		ChooseHTML='';
		HitC = 0;

		$xml.find("item").each(function() {
			if(HitC<=5){
				ChooseHTML += '<article class="article">';
				ChooseHTML += '<a href="'+ $(this).find("link").text()+ '" target="_blank">';
				ChooseHTML += '<div class="overlay"><img src="https://azuretv2devewu00sca63.blob.core.windows.net/tv2images/choose-logo.png" alt="Show Logo"></div>';
				ChooseHTML +=	'<img src="'+ $(this).find("thumbimage").text() +'" alt="'+ $(this).find("title").text() +'" width="204" height="136">';
				ChooseHTML +=	'</a>';
				ChooseHTML +=	'<h4>'+ $(this).find("title").text() +'</h4>';
				ChooseHTML += '</article>';
				HitC ++
			}
		});
		$( ChooseHTML ).appendTo( $( 'section[data="choosefeed"]' ) );
	});
});
