define(["jquery","underscore","pubsub","utils","abtest-manager","modules/global/alert","managers/trafficcop","managers/requestmanager","managers/resourcemanager","managers/siteconfig","intersection-observer"],function(e,t,i,n,r,o,s,a,p,l,c){"use strict";Object.getPrototypeOf||(Object.getPrototypeOf=function(e){return e.constructor.prototype});var h=function(){this.scrollEl=n.get("scrollEl"),this.body=n.get("body"),this.$win=n.get("win"),this.initialize()};return h.prototype={DEBUG:!0,LAYER_OVERLAY:"overlay",LAYER_PRELOAD:"preload",LAYER_BASE:"base",REFRESH_FREQUENCY:60*(n.getNested(window.site_vars,"REFRESH_RATE")||0)*1e3,start:function(e){var t=l.getSiteConfig();this.started=!0,this.header=e,this.pubSub={"page:unload":this.updateActivityTimestamp,"page:load":this.onPageLoad,"video:load":this.updateActivityTimestamp,"slide:change":this.updateActivityTimestamp,heattrack:this.updateActivityTimestamp,vitrack:this.updateActivityTimestamp,uotrack:this.updateActivityTimestamp,"dom:update":this.onDomUpdate},i.attach(this.pubSub,this),this._setupGlobalPubSub(n.getNested(t,"global","pubSub")),this.startRefreshTimer()},initIntersectionObservers:function(){var i=e(this.getActiveApp().el),n=i.find(".js-llc");if(n.length){if(!this.observer){var r={rootMargin:"300px 50px"};this.observer=new c(t.bind(this.onIntersection,this),r)}n.each(t.bind(function(e,t){this.observer.observe(t)},this))}},clearIntersectionObservers:function(){this.observer&&e(".js-llc,.js-lli").each(t.bind(function(e,t){this.observer.unobserve(t),t.gannett&&(t.gannett={})},this))},resetIntersectionObservers:function(){this.clearIntersectionObservers(),this.initIntersectionObservers()},onIntersection:function(r){t.each(r,function(r){var o=e(r.target),s=o.attr("data-name")||"el",a=r.target.gannett=r.target.gannett||{};if(r.isIntersecting)if(o.hasClass("js-llp")||this.observer.unobserve(r.target),o.hasClass("js-lli"))o.removeClass("js-lli"),n.lazyLoadImage(o);else{a.isIntersecting=!0,a.hasIntersected=!0,a.intersectionCount?a.intersectionCount++:a.intersectionCount=1,o.find(".js-lli").each(t.bind(function(e,t){this.observer.observe(t)},this));var p=o.find(".js-llbi");n.lazyLoadImage(p),p.removeClass("js-llbi"),i.trigger("entered:view:"+s,r.target)}else a.hasIntersected&&(a.isIntersecting=!1,i.trigger("exited:view:"+s,r.target))},this)},_checkForIntersections:function(){this.observer&&this.observer._checkForIntersections&&this.observer._checkForIntersections()},addGlobalScrollListener:function(){var e=t.throttle(this._onScroll,100).bind(this);this.$win.on("scroll."+this.cid,e)},removeGlobalScrollListener:function(){this.$win.off("scroll."+this.cid)},removeScrollListeners:function(){t.each(this.globalScrollListeners,function(e,t){this.$win.off("scroll."+e.name)},this),this.removeGlobalScrollListener(),this.globalScrollListeners=[]},_onScroll:function(e){t.each(this.globalScrollListeners,function(e){try{e.fn()}catch(t){console.error("Failed to execute global scroll handler "+e.name)}})},registerScrollListener:function(e,i,n){if(t.isFunction(i)){n=n||500;var r=t.throttle(i,n);0===this.globalScrollListeners.length&&this.addGlobalScrollListener(),this.globalScrollListeners.push({fn:r,name:e})}},unRegisterScrollListener:function(e){t.each(this.globalScrollListeners,function(t,i){t.name===e&&this.globalScrollListeners.splice(i,1)},this),0===this.globalScrollListeners.length&&this.removeGlobalScrollListener()},stop:function(){this.started=!1,this._currentViewport="width=1070",i.unattach(this.pubSub,this),t.each(n.getNested(this.siteConfig,"global","pubSub"),function(e,t){i.off(t)}),this.removeScrollListeners(),r.stop()},_setupGlobalPubSub:function(e){t.each(e,function(e,n){e instanceof Array||(e=[e]),require(e,t.bind(function(){var e=arguments;this.started&&i.on(n,function(i){t.each(e,function(e){new e(i)})})},this))},this)},initialize:function(){this.$overlayFilm=e("#overlay-film"),this.activeAppInfo={url:null,css:[],layer:null,scrollTop:0,appConfig:null,pageConfig:null,app:null},this.lastUrl=null,this.getActivePageInfo(),this._clearPreloadedAppInfo(),this.fullscreenView=null,this.globalScrollListeners=[],r.start(this.getActivePageInfo())},_clearPreloadedAppInfo:function(){this.preloadedAppInfo={url:null,css:[],scrollTop:0,appConfig:null,pageConfig:null,layer:this.LAYER_PRELOAD,app:null}},onRouteChange:function(e,t){return console.log("App: "+e.page.appName+"/"+e.page.name),this.activeAppInfo.app&&i.trigger("page:unload"),this._loadRoute(e,t)},_loadRoute:function(e,t,i){var n={preloadedUrl:e.page.preloadedUrl||e.app.preloadedUrl};return this._loadApp(e.app.AppClass,n,t,e.app,e.page,i)},_preloadRoute:function(e,t,i){return this._preloadApp(e.app.AppClass,{},t,e.app,e.page,i)},preloadPath:function(t){this.DEBUG&&console.log("Router: Preloading: ",t);var i=l.getRouteInfo(t);return!i||window.chromeless||this.activeAppInfo.layer&&this.activeAppInfo.layer!==this.LAYER_OVERLAY?e.Deferred().reject():this._preloadRoute(i,t)},_loadPath:function(t){var i=l.getRouteInfo(t);return i?this.onRouteChange(i,t):(console.error("StateManager: tried navigating to path, but no match found: "+t),e.Deferred().reject())},refreshActiveApp:function(){var e=this.activeAppInfo.url,t=l.getRouteInfo(e).page,n=p.fetchJavascript(t.path,t.modules),r=this._fetchPathHtml(e);return i.trigger("page:unload"),this._changePage(this.activeAppInfo,e,e,r,n)},setIntentUrl:function(e){this.activeAppInfo.intentUrl=e,this.activeAppInfo.app&&this.activeAppInfo.app.destroyModules()},getIntentUrl:function(){return this.activeAppInfo.intentUrl},getPreloadedUrl:function(){return this.preloadedAppInfo.url},registerFullScreenView:function(e){this._setFixedPosition(this.activeAppInfo,this.activeAppInfo.app,!0),this.fullscreenView=e,this.activeAppInfo.app.pause()},setActiveAppFixed:function(e){this._setFixedPosition(this.activeAppInfo,this.activeAppInfo.app,e)},clearFullScreenView:function(){return this._clearFixedPosition(this.activeAppInfo,this.activeAppInfo.app,!0),this.fullscreenView?(this.fullscreenView=null,this._loadPath(this.activeAppInfo.url)):void 0},clearActiveAppFixed:function(e){this._clearFixedPosition(this.activeAppInfo,this.activeAppInfo.app,e)},_loadApp:function(e,i,n,r,o,s){var a,l=r.overlay?this.LAYER_OVERLAY:this.LAYER_BASE,c=p.fetchJavascript(o.path,o.modules);return this._closeFullscreenView(),this.lastUrl=this.activeAppInfo.url,this.activeAppInfo.app&&(this.activeAppInfo.intentUrl&&this.activeAppInfo.intentUrl!==n&&(this.activeAppInfo.url=this.activeAppInfo.intentUrl),this.activeAppInfo.intentUrl=null),a=this._handleTransition(n,this.activeAppInfo,e,i,l,s,c),this.activeAppInfo.css=o.css||[],this.activeAppInfo.url=n,this.activeAppInfo.layer=l,this.activeAppInfo.pageConfig=o,this.activeAppInfo.appConfig=r,p.fetchStyles(t.union(this.preloadedAppInfo.css,this.activeAppInfo.css),a),a},_preloadApp:function(e,i,n,r,o,s){var a=this._handleTransition(n,this.preloadedAppInfo,e,i,this.LAYER_PRELOAD,s);return this.preloadedAppInfo.css=o.css||[],this.preloadedAppInfo.url=n,this.preloadedAppInfo.pageConfig=o,this.preloadedAppInfo.appConfig=r,p.fetchStyles(t.union(this.preloadedAppInfo.css,this.activeAppInfo.css),a),a},_closeFullscreenView:function(){if(this.fullscreenView){var e=this.fullscreenView;this.fullscreenView=null,e.close()}},_handleTransition:function(e,t,i,n,r,o,s){var a,p=t.url;return this._needsNewApp(i,t)?(a=new i(n),o=o||this._requestPageHtml(p,e,t===this.preloadedAppInfo),t.app?this._changeApps(t,r,a,p,e,o,s):this._revealApp(t,a,p,e,o,s)):t.layer===r?(o=this._requestPageHtml(p,e,t===this.preloadedAppInfo),this._changePage(t,p,e,o,s)):this._transitionFromOverlayToPreloadedApp(p,e,s)},_changeApps:function(i,n,r,o,s,a,p){return i.layer===n?i.app.removeApp(o,s).then(t.bind(function(){return this._revealApp(i,r,o,s,a,p)},this)):n===this.LAYER_OVERLAY?this._revealOverlay(r,o,s,a,p):e.when(this._removePreloadedApp(o,s),this._removeOverlay(i.app,o,s)).then(t.bind(function(){return this._revealApp(i,r,o,s,a,p)},this))},updateState:function(){var t=this.activeAppInfo;if(t.appConfig&&t.pageConfig){this.header&&this._setHeader(this.header,e.extend({},t.appConfig.header,t.pageConfig.header));var i=t.appConfig.viewport||t.pageConfig.viewport||"width=1070";this._currentViewport!==i&&(this._currentViewport=i,e("meta[name=viewport]").attr("content",i))}},_setHeader:function(e,i){t.isEmpty(i)?e.restoreDefaultState():i.fixed?i.open?e.setOpenFixed():e.setClosedFixed():e.setFixingScroller(!0)},_changePage:function(e,i,n,r,o){return e.app.changePage(i,n,r,o,e===this.preloadedAppInfo).then(null,t.bind(function(t,o){return"InvalidApp"===t&&o?this._invalidateApp(e,o,i,n,r):void 0},this))},_rerouteInitialPageLoad:function(i,n,r){return e.Deferred(function(e){t.defer(function(){i.app=null,i.url=null,e.resolve()})}).then(t.bind(function(){return this._loadRoute(r,n)},this))},_removePreloadedApp:function(e,t){var i=this.preloadedAppInfo.app;return i?(this._clearPreloadedAppInfo(),i.beforeOverlayRemove(t),i.removeApp(e,t)):void 0},_revealApp:function(e,i,n,r,o,s){return e.app=i,i.revealApp(n,r,o,s,e===this.preloadedAppInfo).then(null,t.bind(function(t,i){return"InvalidApp"===t&&i?this._invalidateApp(e,i,n,r,o):void 0},this))},_invalidateApp:function(e,t,i,n,r){try{e.app.destroy()}catch(o){console.error("View threw an exception on destroy: ",o.stack||o.stacktrace||o.message)}return console.log("Rerouting: "+t.page.appName+"/"+t.page.name),r?(e.url=i,e===this.activeAppInfo?this._loadRoute(t,n,r):this._preloadRoute(t,n,r)):this._rerouteInitialPageLoad(e,n,t)},_needsNewApp:function(e,t){return!(t.app&&t.app.isRevealed()&&(Object.getPrototypeOf(t.app)===e.prototype||this.preloadedAppInfo.app&&Object.getPrototypeOf(this.preloadedAppInfo.app)===e.prototype&&this.preloadedAppInfo.app.isRevealed()))},_requestPageHtml:function(i,o,s){var p=r.getUserTestByTargetAndPath("full-page",o),l=n.getNested(p,"userVariant","options")||{},c=l.altUrl,h=t.omit(l,"altUrl");if(c&&!t.isEmpty(h)&&(c+="?"+e.param(h)),null!==i||s||c){if(i!==o)return c?this._fetchPathHtml(c,!1,{ignoreVersionCheck:!0}):this._fetchPathHtml(o,s);s||a.abortAllRequests()}return null},_transitionFromOverlayToPreloadedApp:function(e,i,n){var r=this.preloadedAppInfo,o=this._requestPageHtml(r.url,i,!1),s=this.activeAppInfo.app;return this._movePreloadAppToActiveApp(this.LAYER_BASE),r.app.beforeOverlayRemove(i),this._removeOverlay(s,e,i).then(t.bind(function(){return this.updateState(),this._transitionFromOverlayScroll(r),this._changePage(r,e,i,o,n)},this))},_removeOverlay:function(t,i,n){return e.when(t.removeApp(i,n),this._fadeOutOverlayFilm(t))},_movePreloadAppToActiveApp:function(t){e.extend(this.activeAppInfo,this.preloadedAppInfo),i.trigger("activePageInfo:set",this.activeAppInfo.app.pageInfo),this.activeAppInfo.layer=t,this._clearPreloadedAppInfo()},_deactivateActiveApp:function(){this.activeAppInfo.app.pause(),e.extend(this.preloadedAppInfo,this.activeAppInfo)},_revealOverlay:function(n,r,o,s,a){var p=this.activeAppInfo.app;p.isRevealed()?this._deactivateActiveApp():(p.removeApp(r,o),p=null),this.body.css("overflow-y","scroll"),this._transitionToOverlayScroll(this.preloadedAppInfo);var l=e.when(this._fadeInOverlayFilm(n),this._revealApp(this.activeAppInfo,n,r,o,s,a));return i.trigger("scrollTop",0),l.done(t.bind(function(){this.body.css("overflow-y",""),p&&!p.destroyed&&p.afterOverlayReveal(this.preloadedAppInfo.scrollTop)},this)),l},_fadeInOverlayFilm:function(t){var i=t.options.animations.fadeIn;return this.$overlayFilm.length||(this.$overlayFilm=e('<div class="ui-film"></div>'),this.body.append(this.$overlayFilm)),t.animate(this.$overlayFilm,"opacity",.7,i.duration,"ease-in")},_fadeOutOverlayFilm:function(t){var i=this.$overlayFilm,n=t.options.animations.fadeOut;return this.$overlayFilm=e([]),t.animate(i,"opacity",0,n.duration,"ease-out").done(function(){i.remove()})},_fetchPathHtml:function(e,i,r){var s=this.fetchHtml(e,r||null,!i);return i||s.fail(t.bind(function(e){if(e)if("NOT AUTHORIZED"===e)window.location.assign(n.getNested(window,"firefly_urls","samSubscribeURL")||"");else{var t=this.generateRequestError(e);t&&o.showError(t),(200!==e.status&&e.status||"timeout"===e.statusText)&&window.history.back()}},this)),s},generateRequestError:function(e){if(e){if(500===e.status)return"Connection Error... (INTERNAL SERVER ERROR)";if(404===e.status)return"Connection Error... (FILE NOT FOUND)";if(200!==e.status&&e.status)return"Connection Error... ("+(e.statusText||"Unknown Error")+")"}return null},_transitionFromOverlayScroll:function(e){var t=e.app;t&&(t.isApple?t.show():this._clearFixedPosition(e,t),t.$el.css("z-index",""))},_transitionToOverlayScroll:function(e){var t=e.app;t&&(t.isApple?t.hide():this._setFixedPosition(e,t),t.$el.css("z-index","0"))},_clearFixedPosition:function(e,t,n){t.clearFixedPosition(n),i.trigger("scrollTop",e.scrollTop||0)},_setFixedPosition:function(e,t,r){var o=t.getWindowOffset().top;e.scrollTop=n.getScrollPosition(),i.trigger("scrollTop",0),t.setFixedPosition(o,r)},onPageLoad:function(){n.flag("lazy_load")&&this.resetIntersectionObservers(),this.updateActivityTimestamp()},onDomUpdate:function(){this._checkForIntersections()},updateActivityTimestamp:function(){this.lastActivityTimestamp=(new Date).getTime()},getActivePageInfo:function(){var e=n.getNested(this.activeAppInfo,"app","pageInfo");return e?e:(this.initialPageInfo||(this.initialPageInfo=n.parsePageInfo(this.body),this.initialPageInfo.headerAbVariant=this.body.attr("data-ab-variant")),this.initialPageInfo)},getActiveAppClientInfo:function(){return this.activeAppInfo.app&&this.activeAppInfo.app.getClientInfo()||{}},getPreloadedPageInfo:function(){return this.preloadedAppInfo.app&&this.preloadedAppInfo.app.pageInfo||{}},getActiveApp:function(){return this.activeAppInfo.app},getPreloadedApp:function(){return this.preloadedAppInfo.app},getReferrer:function(){return null===this.lastUrl?document.referrer:n.getOrigin()+this.lastUrl},getCurrentUrl:function(){return this.activeAppInfo.url?n.getOrigin()+this.activeAppInfo.url:window.location.href},startRefreshTimer:function(){!this.refreshTimer&&this.REFRESH_FREQUENCY&&(this.lastActivityTimestamp=0,this.refreshTimer=setInterval(t.bind(function(){if(!this.fullscreenView&&this.activeAppInfo.layer!==this.LAYER_OVERLAY){var e=(new Date).getTime(),t=e-this.lastActivityTimestamp;t>this.REFRESH_FREQUENCY&&(i.trigger("site:refresh","refresh:"+(this.getActivePageInfo().ssts||"").replace(/[\/:].*/,"")),window.location=window.location)}},this),6e4))},stopRefreshTimer:function(){this.refreshTimer&&(clearInterval(this.refreshTimer),this.refreshTimer=null)},registerAnimation:function(e,t,i,n,r){return s.addAnimation(e,t,i,n,r)},fetchHtml:function(e,t,i,n){return a.fetchHtml(e,t,i,n,!0)},persistentFetchHtml:function(e,t,i,n){return a.persistentFetchHtml(e,t,i,n,!0)},fetchData:function(e,t,i,n,r){return a.fetchData(e,t,i,n,r)},persistentFetchData:function(e,t,i,n,r){return a.persistentFetchData(e,t,i,n,r)},recurringFetchHtml:function(e,t,i,n,r){return a.recurringFetchHtml(e,t,i,n,r,!0)},recurringFetchData:function(e,t,i,n,r,o){return a.recurringFetchData(e,t,i,n,r,o)}},window.stateManager=new h,window.stateManager});
//# sourceMappingURL=statemanager.js.map