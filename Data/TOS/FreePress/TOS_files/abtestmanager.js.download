define(["jquery","underscore","utils","pubsub","cookie"],function(t,e,s,r){"use strict";var n=function(){this.userTestSlot=0,this.slotKey="ab_test_slot"};return n.prototype={start:function(t){this.pubSub={"activePageInfo:set":this._onActivePageInfoSet},r.attach(this.pubSub,this),this.userTestSlot=this._getUserTestSlot(),this.initialPath=window.location.pathname,this.processPageInfo(t)},stop:function(){r.unattach(this.pubSub,this),this._clearUserTestSlot(),this.userTestSlot=0,this.tests=[]},processPageInfo:function(t){t=t||{},this._processTests(t),t.user=t.user||{},t.user.abTestSlot=this.userTestSlot,t.user.abTest=this.getUserTest()},_onActivePageInfoSet:function(t){s.getNested(t,"routePath")!=this.initialPath?this.processPageInfo(t):this.initialPath=null},getTests:function(){return this.tests},getCurrentTests:function(){return this.currentTests},getTestById:function(t){return e.find(this.getTests(),function(e){return e.id===t})},getTestByVariant:function(t){return e.find(this.getTests(),function(s){return e.find(s.variants,function(e){return e.id===t})})},getUserTests:function(){return this.userTests},getUserTest:function(){return this.userTest},getUserTestByTargetAndPath:function(t,s){return e.find(this.userTests,function(e){return e.testTarget===t?new RegExp(e.urlRegex).test(s):void 0})},getUserTestByTarget:function(t){return s.getNested(this.userTest,"testTarget")===t?this.userTest:void 0},_isUserInVariantRange:function(t){return t.trafficRange&&this.userTestSlot>=t.trafficRange.start&&this.userTestSlot<=t.trafficRange.end},_processTests:function(r){this.tests=r.abtests||[],this.currentTests=[],this.userTests=[],this.userTest=null,e.each(this.tests,function(n){var i=this._isTestCurrent(n);if(e.each(n.variants,function(e){var a;e.id===r.headerAbVariant&&(a=n.isHeaderVariantTest=!0);var o=a||i&&this._isUserInVariantRange(e);o&&(n.userVariant=e,n.userVariant.options=t.extend(!0,s.getNested(n,"defaultVariantOptions"),s.getNested(e,"options"))),e.control===!0&&(n.controlVariant=e)},this),n.userVariant){this.userTests.push(n);try{(n.isHeaderVariantTest||new RegExp(n.urlRegex).test(window.location.pathname))&&(this.userTest=n)}catch(a){return!1}}i&&this.currentTests.push(n)},this)},_getUserTestSlot:function(){return this._readUserTestSlot()||this._setUserTestSlot()},_readUserTestSlot:function(){return JSON.parse(window.localStorage.getItem(this.slotKey))},_setUserTestSlot:function(){var t=Math.floor(100*Math.random())+1;try{window.localStorage.setItem(this.slotKey,JSON.stringify(t))}catch(e){console.error("Failed saving userTestSlot",e.stack||e.stacktrace||e.message)}return t},_clearUserTestSlot:function(){window.localStorage.removeItem(this.slotKey)},_isTestCurrent:function(t){var e=new Date;return new Date(t.endTime)>e&&new Date(t.startTime)<e}},window.abTestManager=new n,window.abTestManager});
//# sourceMappingURL=abtestmanager.js.map