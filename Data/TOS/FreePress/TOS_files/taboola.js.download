define(["jquery","underscore","utils","state","managers/cachemanager"],function(e,t,i,o,s){"use strict";var a=function(o){t.bindAll(this,"getWidget");var s=i.getNested(window.site_vars,"THIRDPARTYAPI","Taboola")||{};this.options=e.extend({apiBase:s.apiBase+s.api_id,apiKey:s.apiKey,widgetUrl:"//cdn.taboola.com/libtrc/"+s.publisher_id+"/loader.js",isWidgetPresent:s.widget,taboola_enabled:s.ENABLED,isContinuousEndslate:!1},o),this.options.isWidgetPresent&&!this.options.isContinuousEndslate&&i.loadScript(this.options.widgetUrl,"_taboola",this.getWidget)};return a.prototype={setUserTaboolaSession:function(e){s.setValue("taboola_user_session_id",e)},getUserTaboolaSession:function(){return s.getValue("taboola_user_session_id","init")},getSourceId:function(t){var i=t?e("<a>").attr("href",t)[0].pathname:window.location.pathname;return i.match(/^\/videos\//)?o.getActivePageInfo().assetid:i},registerTaboolaClick:function(e,t,i){(new Image).src=this.options.apiBase+"/recommendations.notify-click?app.type=desktop&app.apikey="+this.options.apiKey+"&response.id="+i+"&item.type="+t+"&item.id="+e+"&response.session="+this.getUserTaboolaSession()},registerTaboolaVisible:function(e){(new Image).src=this.options.apiBase+"/recommendations.notify-visible?app.type=desktop&app.apikey="+this.options.apiKey+"&response.id="+e+"&response.session="+this.getUserTaboolaSession()},getRelated:function(s,a,n,r,p,l,d,c,u,g){var h,b,m,f,y,v,w=e.Deferred();return this.options.taboola_enabled?(h=o.getActivePageInfo(),b={video:"video",playlist:"video",brightcove:"video",text:"text",story:"text",blogs:"text",gallery:"photo",album:"photo",home:"home",section:"section",front:"section",topic:"section","blog index":"section","media view":"section"},m=t.keys(b).join("|"),f=i.getNested(h,"contenttype")||"",y=this.options.apiBase+"/recommendations.get",v=JSON.parse(JSON.stringify({"output.callback":"define","app.type":"desktop","app.apikey":this.options.apiKey,"source.id":l||this.getSourceId()||0,"source.url":p||i.getNested(h,"canonical")||window.location.href,"source.type":a||b[f.match(m)]||"video","rec.type":n||"video","rec.visible":c===!1?c:!0,"rec.count":r||3,"source.placement":d||"","user.session":this.getUserTaboolaSession(),"rec.thumbnail.width":u,"rec.thumbnail.height":g})),i.requireSingleUseScript(y+"?"+e.param(v)).done(t.bind(function(e){i.set("taboolaResponseID",e.id),e.list||(e.list={}),this.setUserTaboolaSession(e.session),v["rec.visible"]&&this.registerTaboolaVisible(e.id),s?s(e):w.resolve(e)},this)).fail(function(e){e={},w.reject(e)})):w.reject("Taboola not enabled for this site."),w.promise()},getWidget:function(i){if(this.options.taboola_enabled){var o=window.location.href;window.taboolainitialized||(i.push({notify:"newPageLoad"}),window.taboolainitialized=!0),t.each(this.options.widget,function(e){i.push({mode:e.mode,container:e.container,placement:e.placement,target_type:e.target_type,url:e.url})}),i.push(e.extend({url:o},this.options.pagetypeWidget))}}},a});
//# sourceMappingURL=taboola.js.map