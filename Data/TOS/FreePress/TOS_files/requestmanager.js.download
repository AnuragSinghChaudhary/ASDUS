define(["jquery","underscore","managers/trafficcop","utils"],function(e,t,i,r){var n=function(){this.DEBUG=!0,this.xhrList=[],this.intervalList=[]};return e(document).ajaxSend(function(t,i,r){"post"===r.method&&i.setRequestHeader("X-CSRFToken",e.cookie("csrftoken"))}),n.prototype={timeout:3e4,fetchHtml:function(e,t,i,r){return this.fetchData(e,t,i,r,!0)},persistentFetchHtml:function(e,t,i,r){return this.fetchData(e,t,i,r,!0,!0)},recurringFetchHtml:function(e,t,i,r,n){return this.recurringFetchData(e,t,i,r,n,!0)},recurringFetchData:function(e,i,r,n,s,a){var o=t.bind(function(){this.fetchData(e,i,!1,s,a).done(function(e){n(e)})},this);o();var u=setInterval(o,r);return this.intervalList.push(u),u},fetchData:function(i,r,n,s,a,o){r=this._setupRequest(i,r,s);var u=e.Deferred();this._startRequest(u,r,n,a,void 0,o);var c=u.promise();return c.abort=t.bind(function(){u.reject()},this),c},persistentFetchData:function(e,t,i,r,n){return this.fetchData(e,t,i,r,n,!0)},_setupRequest:function(t,i,r){var n={};return r&&(n["X-PJAX"]="true",n["X-PJAX-Container"]="#overlay"),t?0!==t.indexOf("/")&&0!==t.indexOf("http")&&(t="/"+t):t="/",i=e.extend({url:t,data:{ajax:!0},beforeSend:function(t){e.each(n,function(e,i){t.setRequestHeader(e,i)})},timeout:this.timeout},i)},_startRequest:function(t,r,n,s,a,o){var u=this._initializeFetchData(r.url,n,o);if(!u)return void t.reject();var c=t.promise().ajaxPromise=e.ajax(r);this.DEBUG&&c.fail(function(e){e.statusText&&"abort"!==e.statusText&&console.log("fetchData Error: ",e.statusText,r)}),t.fail(function(){"pending"===c.state()&&c.abort()}),c=i.addRequest(c),this._registerNavRequests(c,t,r.url,n,o),n?this._resolveNavAjax(c,t,r,n,s,a):this._resolveAjax(c,t,s)},_refreshPage:function(){window.location=window.location},_resolveNavAjax:function(e,i,r,s,a,o){e.done(t.bind(function(){var t=e.original.getResponseHeader("X-Firefly-Session-Needed"),n=e.original.getResponseHeader("X-Gannett-Site-Version");t?this._handleFireflyAuth(t,i,r,s,a,o):n&&window.site_static_version!==n&&!r.ignoreVersionCheck?this._refreshPage():this._resolveAjax(e,i,a)},this)).fail(function(){n.prototype._resolveAjax(e,i,a)})},_handleFireflyAuth:function(e,i,r,n,s,a){if(a)console.error("Auth failed, X-Firefly-Session-Needed appeared on refetch"),i.reject("NOT AUTHORIZED");else{console.log("Requesting FIREFLY Auth");var o=this._getFireflyAuth(e).done(t.bind(function(){console.log("FIREFLY Auth Successful, requesting original asset"),this._startRequest(i,r,n,s,!0)},this)).fail(function(e,t){i.reject(e,t)});i.fail(function(){o.reject()})}},_resolveAjax:function(e,t,i){e.done(function(r){i&&(r=n.prototype._toHtml(r)),t.resolveWith(e,[r])}).fail(function(i){t.rejectWith(e,[i])})},_toHtml:function(t){var i=document.createDocumentFragment(),r=document.createElement("div");return r.innerHTML=t,i.appendChild(r),e(i).children().children()},_getFireflyAuth:function(i){var n,s=Math.floor(1e3*Math.random()),a=this._createFireflyiFrame(i);return e.Deferred(t.bind(function(t){n=setTimeout(function(){console.error("Auth timeout occurred"),t.reject("NOT AUTHORIZED","Request Timed Out")},this.timeout),e(window).on("message.rqman"+s,function(e){if(e=e.originalEvent,e.origin===r.getOrigin())try{var i=JSON.parse(e.data);if("firefly-auth"!==i.type)return;if("success"===i.auth)return void t.resolve(i);t.reject("NOT AUTHORIZED",i)}catch(n){}})},this)).always(function(){clearTimeout(n),e(window).off(".rqman"+s),document.body.removeChild(a)})},_createFireflyiFrame:function(e){var i=document.createElement("iframe");return i.id=i.name=t.uniqueId("firefly_auth_"),i.className="hidden",i.src=e,document.body.appendChild(i),i},_registerNavRequests:function(e,i,r,n,s){var a={ajaxPromise:e,resultDeferred:i,url:r,isNav:n,isPersistent:s};this.xhrList.push(a),e.always(t.bind(function(){this.xhrList=t.without(this.xhrList,a)},this))},_initializeFetchData:function(e,t,i){var r=1==this.xhrList.length&&this.xhrList[0],n=r&&r.isNav;if(i)return!0;if(t){if(n&&r.url===e)return!1;this.abortAllRequests()}else if(n)return!1;return!0},abortAllRequests:function(){t.each(this.xhrList,function(e){e.isPersistent||(e.ajaxPromise.abort(),e.resultDeferred.reject())}),t.each(this.intervalList,function(e){clearInterval(e)}),this.xhrList=t.where(this.xhrList,{isPersistent:!0}),this.intervalList=[]},done:function(){return e.when(this.xhrList)}},new n});
//# sourceMappingURL=requestmanager.js.map