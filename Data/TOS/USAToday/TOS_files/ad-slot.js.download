define(["jquery","underscore","baseview","state","utils","modules/global/memobarrier","pubsub","adLogger"],function(t,e,i,s,o,n,a,r){"use strict";var d=i.extend({className:"ad-slot",id:function(){return e.uniqueId("ad-slot-"+this.options.adUnit.replace(/\//g,"-")+"-")},events:{partnersetup:"onHighImpactAdLoad",partnerloading:"onPartnerLoading"},pageLoaded:!1,initialized:!1,queue:[],pageUnLoad:function(){d.prototype.pageLoaded=!1},pageLoad:function(){d.prototype.queue.length&&d.prototype._requestSlots(d.prototype.queue),d.prototype.queue=[],d.prototype.pageLoaded=!0},initialize:function(s){if(s=t.extend({adUnit:null,exclusion:[],targeting:{},sizes:[],type:"in",onSlotSetup:null,onSlotRequest:null,onSlotRender:null,onSlotEmpty:null,position:null,adPosition:null},s),e.bindAll(this,"_prebidBidBack","_apsBidBack"),!d.prototype.initialized&&window.googletag&&(d.prototype.initialized=!0,googletag.cmd.push(function(){googletag.pubads().addEventListener("slotRenderEnded",d.prototype._renderEnded)})),!(this.$el.length&&s.position&&s.position.length&&s.position.parents("body").length))return void r.logInfo("AdSlot("+this.options.adUnit+"): Unable to request ad because no valid dom element provided");this.apsScriptLoad=t.Deferred(),this.apsBarrier=new n;var l=o.getNested(window.site_vars,"ADS","aps","timeout")||1e3;this.apsBarrier.add(this.apsScriptLoad,l,!0),window.apstag?this.apsScriptLoad.resolve():a.on("ads:apsLoaded",this.onApsLoaded,this),s.position.append(this.$el),this.targetBarrier=new n,this.gptSlot=null,this.slotId=this.$el.prop("id"),this.adDeliveryData=null,this.pbDebug=o.getUrlParam("pb_debug"),this.pbSlotLog=o.getUrlParam("pb_slot_log"),this.pbLog=o.getUrlParam("pb_console"),this.iasDebug=o.getUrlParam("ias_debug"),this.apsDebug=o.getUrlParam("aps_debug"),i.prototype.initialize.call(this,s),this._buildGptSlot()},_buildGptSlot:function(){return s.getActivePageInfo().noadvertising?void r.logInfo("AdSlot("+this.options.adUnit+"): blocked because of noadvertising flag in pageinfo"):void("in"===this.options.type?this._registerSlotWithGoogle(this.options.adUnit,this.options.sizes,this.slotId):this._registerOutOfPageSlotWithGoogle(this.options.adUnit,this.slotId))},destroy:function(){a.off("ads:apsLoaded",this.onApsLoaded,this),this.gptSlot&&(this.gptSlot.__gannettSlot=null),window.pbjs&&window.pbjs.removeAdUnit(this.slotId),this.destroyed=!0,this.gptSlot=null,i.prototype.destroy.call(this,!0),delete window.gannettAolConfigs},refresh:function(){this.destroyed||(this.adLoading=!1,this.adData=null,this.$el.closest("body").length||this.options.position.append(this.$el),this.delegateEvents(),this.gptSlot?window.googletag&&!s.getActivePageInfo().noadvertising&&(this._refreshSlot(this.gptSlot),r.logInfo("AdSlot("+this.options.adUnit+"): Ad refreshed for slot",this.gptSlot)):this._buildGptSlot())},onApsLoaded:function(){this.apsScriptLoad.resolve(),a.off("ads:apsLoaded",this.onApsLoaded,this)},onPartnerLoading:function(){this.adLoading=!0},onHighImpactAdLoad:function(t,e){var i=null;if(e&&e.data)i=e.data;else{if(!t.originalEvent||!t.originalEvent.data)return void r.logError("AdSlot("+this.options.adUnit+"): Found a high impact ad, can't find the data object from the iFrame",arguments);i=t.originalEvent.data}if(!i||!i.adType)return void r.logError("AdSlot("+this.options.adUnit+"): high impact event received, but invalid data object was given",i);this.adData=i;var s=this._normalizeAdType(i.adType);this.options.onSlotRender(i,s)},_normalizeAdType:function(t){return t?t.toLowerCase().replace(/[^a-z]/,""):null},_registerOutOfPageSlotWithGoogle:function(t,i){window.googletag&&googletag.cmd.push(e.bind(function(){r.logInfo("AdSlot("+this.options.adUnit+"): registering out of page slot with google "+t),this.gptSlot=googletag.defineOutOfPageSlot(t,i).addService(googletag.pubads()),this.gptSlot.__gannettSlot=this,googletag.display(i),this._refreshSlot(this.gptSlot)},this))},_refreshSlot:function(t){this.setTargeting(),o.getNested(this.options,"skipTargetBarrier")?this._requestSlots([t]):this.targetBarrier.wait().done(e.bind(function(){r.logInfo("Ready to request slot",this.options.adUnit),this.pageLoaded?this._requestSlots([t]):this.queue.push(t)},this))},_requestSlots:function(t){var i=googletag.pubads();return o.checkForEmail(document.location.href)?void(window.noAds=!0):(window.noAds=!1,this.pbLog&&console.log("AD-SLOT: Request slot(s) ---------",Date.now(),t),i.clearTargeting("credit"),i.clearTargeting("videotag"),e.each(t,function(t){"function"==typeof t.clearTargeting&&(t.clearTargeting("credit"),t.clearTargeting("videotag")),t&&t.__gannettSlot&&t.__gannettSlot.options&&t.__gannettSlot.options.onSlotRequest()}),i.refresh(t),void 0)},_registerSlotWithGoogle:function(t,i,s){window.googletag&&(t=this._sanitizeAdUnit(t),googletag.cmd.push(e.bind(function(){var n=o.getNested(this.options,"onSlotSetup"),a=o.getNested(this.options,"deferred");r.logGroup("AdSlot "+this.options.adUnit),r.logInfo("registering slot with google "+t+" sizes",i),this.gptSlot=googletag.defineSlot(t,i,s).addService(googletag.pubads()),n&&"function"==typeof n&&this.options.onSlotSetup(this.options.adPosition,s),this.gptSlot.__gannettSlot=this,googletag.display(s),e.forEach(arguments,function(e){r.logInfo("AdSlot("+t+"): "+e)}),a?a.done(e.bind(function(){this._refreshSlot(this.gptSlot)},this)):this._refreshSlot(this.gptSlot),r.logGroupEnd(),(o.getNested(window.site_vars,"ADS","ias","enabled")||this.iasDebug)&&(window.iasSlots=window.iasSlots||[],window.iasSlots.push({adSlotId:s,size:i[0],adUnitPath:t}))},this)))},_sanitizeAdUnit:function(t){return"string"==typeof t?t.replace(/[^\w-*!<>:().\\\/]/g,""):""},_renderEnded:function(t){t.slot.__gannettSlot&&e.defer(e.bind(function(){!this.gptSlot||this.adData||this.adLoading||(t.isEmpty?(r.logInfo("AdSlot("+this.options.adUnit+"): No Ad Delivered"),this.options.onSlotEmpty&&this.options.onSlotEmpty()):this.options.onSlotRender(null,null,t.size),a.trigger("ads:renderSuccess",{empty:t.isEmpty,adUnit:this.options.adUnit}))},t.slot.__gannettSlot))},setTargeting:function(t){var e=t||this.options.targeting;this.gptSlot&&(this._setTargeting(this.gptSlot,e),this._setExclusionTargeting(this.gptSlot,this.options.exclusion))},_getMaxSize:function(t){var i;return t.length>1?e.reduce(t,function(t,e){var s=e[0]+e[1];return s>t?(i=e,s):t},0):i=t[0],i},_getPrebid:function(t,i,n){if(!o.getUrlParam("pb_video_id")){var a,r,d,l=[],p=window.pbjs||{},g=o.getNested(window.site_vars,"ADS","prebid")||{},u=-1!==t.indexOf("_btf")?"btf":"atf",h=o.getNested(g,"aol")||{},c=o.getNested(g,"appNexus")||{},f=o.getNested(g,"criteo")||{},b=o.getNested(g,"index")||{},S=o.getNested(g,"openX")||{},_=o.getNested(g,"rubicon")||{},m=o.getNested(g,"pubMatic")||{},v=o.getNested(g,"sonobi")||{},w=o.getNested(g,"triplelift")||{},D=o.getNested(g,"yieldbot")||{},A=o.getNested(g,"trustx")||{},y=o.getNested(g,"aardvark")||{},z=o.getNested(g,"sizes"),L=s.getActivePageInfo(),N=L.section_name;if(p.adUnits&&e.where(p.adUnits,{code:n}).length)return this._fetchPrebid(n);if(!z)return!1;if(z=e.map(z,function(t){return[t.width,t.height]}),i=e.filter(i,function(t){return e.findWhere(z,t)}),e.isEmpty(i))return!1;if(r=this._getMaxSize(i),!r)return this.preBidDeferred.resolve("No header bidding needed for ad slot");if(d=r[0]+"x"+r[1],("sonobi"===this.pbDebug||!this.pbDebug&&v.enabled)&&l.push({bidder:"sonobi",params:{ad_unit:t}}),("criteo"===this.pbDebug||!this.pbDebug&&f.enabled)&&e.isArray(f.placements)&&this._setupCriteo(f,i,l),"rubicon"===this.pbDebug||!this.pbDebug&&_.enabled){var I=o.getNested(_,"zones",u,N)||_.zoneId;l.push({bidder:"rubicon",params:{accountId:_.account,siteId:_.siteId,zoneId:I,inventory:{domain:window.site_vars.base_url,section:N}}})}if(("appnexus"===this.pbDebug||!this.pbDebug&&c.enabled)&&e.isArray(c.placements)&&this._setupAppNexus(c,i,N,t,l),("openx"===this.pbDebug||!this.pbDebug&&S.enabled)&&e.isArray(S.placements)&&this._setupOpenX(S,i,N,l),("index"===this.pbDebug||!this.pbDebug&&b.enabled)&&this._setupIndex(b,t,l),("triplelift"===this.pbDebug||!this.pbDebug&&w.enabled)&&e.isArray(w.placements)&&this._setupTripleLift(w,i,l),("yieldbot"===this.pbDebug||!this.pbDebug&&D.enabled)&&this._setupYieldbox(D,t,i,l),("trustx"===this.pbDebug||!this.pbDebug&&A.enabled)&&this._setupTrustx(A,i,l),("aardvark"===this.pbDebug||!this.pbDebug&&y.enabled)&&this._setupAardvark(y,i,N,l),("pubmatic"===this.pbDebug||!this.pbDebug&&m.enabled)&&e.isArray(m.slots)){var x=u.toUpperCase()+"@"+d,E="ROS@"+d,P=m.slots.indexOf(x)>-1?x:m.slots.indexOf(E)>-1?E:null;P&&l.push({bidder:"pubmatic",params:{publisherId:m.account,adSlot:P}})}("aol"===this.pbDebug||!this.pbDebug&&h.enabled)&&e.isArray(h.placements)&&this._setupAol(h,t,i,l),a={code:n,sizes:i,bids:l},p.que.push(function(){p.addAdUnits(a)}),p.firstLoad?this._fetchPrebid(n):this.preBidDeferred.resolve(),this.pbSlotLog&&console.info("PREBID SLOT CONFIG",JSON.stringify(a,null,4)),this.pbLog&&console.log("AD-SLOT: Prebid configured -------",Date.now(),a)}},_fetchPrebid:function(t){pbjs.que.push(e.bind(function(){pbjs.requestBids({timeout:o.getNested(window.site_vars,"ADS","prebid","timeout")||800,adUnitCodes:[t],bidsBackHandler:this._prebidBidBack}),this.pbLog&&console.log("AD-SLOT: Fetching slot prebid ----",Date.now(),t)},this))},_prebidBidBack:function(t){pbjs.setTargetingForGPTAsync(),this.preBidDeferred.resolve(),this.pbLog&&console.log("AD-SLOT: Setting prebid targeting ",Date.now(),pbjs.getAdserverTargeting())},_getAps:function(t,e,i){var s=window.apstag||{fetchBids:function(){}},n=s.gannettSlots||[],a=o.getNested(window.site_vars,"ADS","aps","sizes"),r=this._getApsSizes(e,a);if(r.length){var d={slotID:i,sizes:r};this.pbSlotLog&&console.info("AMAZON APS SLOT CONFIG",JSON.stringify(d,null,4)),s.firstLoad?s.fetchBids({slots:[d]},this._apsBidBack):(n.push(d),this.apsBidDeferred.resolve())}},_getApsSizes:function(t,e){var i,s,o,n,a;for(a=[],i=0;i<t.length;i++)for(o=JSON.stringify(t[i]),s=0;s<e.length;s++)n=JSON.stringify([e[s].width,e[s].height]),o===n&&a.push(t[i]);return a},_apsBidBack:function(t){var i=o.getNested(window,"googletag","cmd")||[];i.push(e.bind(function(){var t=window.apstag||{};t.setDisplayBids(),this.apsBidDeferred.resolve()},this)),this.pbLog&&console.log("Setting APS targeting",t)},_setupAol:function(t,i,s,o){var n,a=this._getPlacementSizes(t.placements,s,t.multisize);e.forEach(a,function(s){n=e.where(t.placements,{size:s})[0],n&&o.push({bidder:"aol",params:{placement:n.id,network:t.network,alias:i,server:t.server,sizeId:n.size,bidFloor:t.bidfloor}})})},_setupAppNexus:function(t,i,s,o,n){var a,r,d=this._getPlacementSizes(t.placements,i,t.multisize);e.forEach(d,function(i){a=e.where(t.placements,{size:i})[0],a&&(r=a[s]||a.ros,r&&n.push({bidder:"appnexusAst",params:{placementId:r,keywords:{position:o.split("/")[2]}}}))})},_setupCriteo:function(t,i,s){var o,n=this._getPlacementSizes(t.placements,i,t.multisize);e.forEach(n,function(i){o=e.where(t.placements,{size:i})[0],o&&s.push({bidder:"criteo",params:{zoneId:o.id}})})},_setupTrustx:function(t,i,s){var o,n=this._getPlacementSizes(t.placements,i,t.multisize);e.forEach(n,function(i){o=e.where(t.placements,{size:i})[0],o&&o.uid&&s.push({bidder:"trustx",params:{uid:o.uid}})})},_setupAardvark:function(t,i,s,o){var n,a=this._getPlacementSizes(t.placements,i,t.multisize);e.forEach(a,function(i){n=e.where(t.placements,{size:i})[0],n&&n.ai&&n.sc&&o.push({bidder:"aardvark",params:{ai:n.ai,sc:n.sc,categories:[s]}})})},_setupIndex:function(t,e,i){var s,o=e.split("/")[2];o&&(s=t.placements[o],s&&i.push({bidder:"indexExchange",params:{id:s.id,siteID:s.siteid}}))},_setupOpenX:function(t,i,s,n){var a,r,d=this._getPlacementSizes(t.placements,i,t.multisize);e.forEach(d,function(i){a=e.where(t.placements,{size:i})[0],a&&(r=a[s]||a.ros,r&&n.push({bidder:"openx",params:{unit:r,delDomain:o.getNested(t,"domain")}}))})},_setupTripleLift:function(t,i,s){var o,n=this._getPlacementSizes(t.placements,i,t.multisize);e.forEach(n,function(i){o=e.where(t.placements,{size:i})[0],o&&s.push({bidder:"triplelift",params:{inventoryCode:o.id}})})},_setupYieldbox:function(t,i,s,o){var n,a=this._getPlacementSizes(t.placements,s,t.multisize);e.forEach(a,function(i){n=e.where(t.placements,{size:i})[0],n&&o.push({bidder:"yieldbot",params:{psn:n.id,slot:n.slot}})})},_getPlacementSizes:function(t,i,s){var o,n=[],a=[];return e.forEach(t,function(t){var s=t.size.split("x");s=e.map(s,function(t){return parseInt(t,10)});var o=e.findWhere(i,s);o&&a.push(o)}),e.isEmpty(a)?void 0:(e.reduce(a,function(t,e){var i=e[0]+e[1];return n.push(e[0]+"x"+e[1]),i>t?(o=e[0]+"x"+e[1],i):t},0),s?n:[o])},_setTargeting:function(i,s){var n,a=o.getNested(this.options,"adUnit")||"",d=o.getNested(this.options,"sizes")||[];i.clearTargeting(),(o.getNested(window.site_vars,"ADS","prebid","enabled")||this.pbDebug)&&(n=o.getNested(window.site_vars,"ADS","prebid","timeout")+100||900,this.preBidDeferred=t.Deferred(),this.targetBarrier.add(this.preBidDeferred,n,!0),this._getPrebid(a,d,this.slotId)),(o.getNested(window.site_vars,"ADS","aps","enabled")||this.apsDebug)&&(n=o.getNested(window.site_vars,"ADS","aps","timeout")||1e3,this.apsBidDeferred=t.Deferred(),this.targetBarrier.add(this.apsBidDeferred,n,!0),this.apsBarrier.wait().then(e.bind(function(){this._getAps(a,d,this.slotId)},this))),i.setTargeting("position",a.split("/")[2]||"NA"),e.each(s,function(t,e){(t||0===t||t===!1)&&(t=o.scrubEmail(t),i.setTargeting(e,t),r.logInfo("set targetting - key:"+e+" value:"+t))},this)},_setExclusionTargeting:function(t,i){e.each(i,function(i){i&&!e.isEmpty(i)&&(t.setCategoryExclusion(i),r.logInfo("set exclusion targetting -  value:"+i))},this)}});return d});
//# sourceMappingURL=ad-slot.js.map