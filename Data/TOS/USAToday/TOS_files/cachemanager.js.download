define(["jquery","underscore"],function(e,t){"use strict";var r=function(){t.bindAll(this,"_updateCache"),window.addEventListener?window.addEventListener("storage",this._updateCache,!1):window.attachEvent("onstorage",this._updateCache),this.reset(),this.getValue("cmgc",this.gc,10080)};return r.prototype={keyPrefix:"wf_",reset:function(){this._cache={}},gc:function(){var e=r.prototype;t.each(t.keys(window.localStorage),function(t){0===t.indexOf(e.keyPrefix)&&(e._getBrowserCache(window.localStorage,t)||window.localStorage.removeItem(t))})},_updateCache:function(r){var i;r||(r=window.event),r.key&&0===r.key.indexOf(this.keyPrefix)&&(r.newValue?(i=JSON.parse(r.newValue),t.isObject(i)&&"raw"!==i.type&&(i.data=e.Deferred().resolve(i.data)),this._setMemoryCache(r.key,i)):delete this._cache[r.key])},getValue:function(e,r,i){var a,n,s,o=this._getStorage(i);return e=this.keyPrefix+e,a=this._getMemoryCache(e),a||(a=this._getBrowserCache(o,e),a||(n=this._getValue(r),s=this._isPromise(n),a=this._buildCacheEntry(n,s,i),s?n.done(t.bind(function(t){var r=this._buildCacheEntry(t,!0,i);this._setBrowserCache(e,r,o)},this)):this._setBrowserCache(e,a,o)),this._setMemoryCache(e,a)),a.data},setValue:function(e,r,i){var a=this._isPromise(r),n=this._buildCacheEntry(r,a,i);e=this.keyPrefix+e,a?r.done(t.bind(function(t){var r=this._buildCacheEntry(t,!0,i);this._setBrowserCache(e,r,this._getStorage(i))},this)):this._setBrowserCache(e,n,this._getStorage(i)),this._setMemoryCache(e,n)},_isPromise:function(t){return e.isPlainObject(t)&&e.isFunction(t.promise)},_getStorage:function(e){var t=e?"localStorage":"sessionStorage";return window[t]},_setMemoryCache:function(e,t){this._cache[e]=t},_setBrowserCache:function(e,t,r){try{r.setItem(e,JSON.stringify(t))}catch(i){console.log("Storage Set Failed for key: "+e)}},_buildCacheEntry:function(e,t,r){var i,a={data:e,type:t?0:"raw"};return r&&(i=new Date,a.expires=i.setTime(i.getTime()+1e3*r*60)),a},clearValue:function(e){e=this.keyPrefix+e,sessionStorage.removeItem(e),localStorage.removeItem(e),delete this._cache[e]},_getMemoryCache:function(e){var t=this._cache[e];if(t){if("raw"!==t.type){if("pending"===t.data.state())return t;if("rejected"===t.data.state())return null}if(!t.expires)return t;if(new Date<new Date(t.expires))return t}},_getBrowserCache:function(r,i){var a=r.getItem(i);return a&&(a=JSON.parse(a),t.isObject(a)&&(!a.expires||new Date<new Date(a.expires)))?("raw"!==a.type&&(a.data=e.Deferred().resolve(a.data)),a):void 0},_getValue:function(t){return e.isFunction(t)?t():t}},new r});
//# sourceMappingURL=cachemanager.js.map