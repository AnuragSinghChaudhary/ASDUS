define(["jquery","underscore","baseview","state","managers/trafficcop","site-manager","utils","pubsub","managers/resourcemanager","managers/routemanager","abtest-manager","third_party_integrations/sourcepoint/sourcepoint-utils"],function(e,t,i,s,n,a,r,o,d,h,f){"use strict";var u=i.extend({currentPath:"",initialize:function(t){this._animId=0,this._fixedOffset=null,this.$top=r.get("scrollEl"),this.appRevealed=!1,this.pubSub=e.extend({"header:fixed":this._onHeaderFixed,"header:unfixed":this._onHeaderUnfixed},this.pubSub),i.prototype.initialize.call(this,t)},isRevealed:function(){return this.appRevealed},revealApp:function(e,t,i,s,n){var a=this._buildRequestInfo(e,t,i,s,n);return i?"rejected"===i.state()?i:this._handleAsyncReveal(i,a):this._handleInitialReveal(a)},_buildRequestInfo:function(t,i,s,n,a){return{fromUrl:t,toUrl:i,animId:++this._animId,resourcePromise:n||e.Deferred().resolve(),requestPromise:s||e.Deferred().resolve(),modulePromise:e.Deferred(),paused:a}},_handleInitialReveal:function(i){var s=e(".site-header").next();s.length||(s=r.get("body")),this.setElement(s);var n=this._setPageInfo(s,i);return this._isCorrectApp(n.jsUrl).then(t.bind(function(){return this.$el.hasClass("js-ab-app-el")&&(this.$el.removeClass("js-ab-app-el"),this.$(".js-ab-content-el").removeClass("js-ab-content-el"),this.$(".js-ab-loader").remove()),this._triggerAfterPageReveal(i)},this))},_handleAsyncReveal:function(i,s){var n;return"resolved"===i.state()?i.then(t.bind(function(e){return this._triggerBeforePageReveal(e,s).then(t.bind(function(){return this._updateState(s),this._revealAppMarkup(e,s).then(t.bind(function(){return this._finishReveal(e,s)},this))},this))},this)):(n=this.getRevealAppLoader(s.toUrl),n instanceof e||(n=e(n)),this._revealAppMarkup(n,s).then(t.bind(function(){return this.afterLoaderReveal(),i.then(t.bind(function(e){return this._triggerBeforePageReveal(e,s).then(t.bind(function(){return this._updateState(s),this._handleRevealLoaderContentSwap(e,s).then(t.bind(function(){return this.setElement(e,!1),this._finishReveal(e,s)},this))},this))},this))},this)))},_updateState:function(e){e.paused||s.updateState()},_revealAppMarkup:function(t,i){this._insertAppMarkup(t,i.paused);var s=this._safeCall("animateRevealApp",i.fromUrl,i.toUrl,i.paused);return s?n.addAnimation(s):e.Deferred().resolve()},_handleRevealLoaderContentSwap:function(t,i){return i.animId!==this._animId?e.Deferred().reject():(this.beforeLoaderRemove(),this.swapContent(this.$el,t,i.paused,this.getHash(i.toUrl)))},_finishReveal:function(t,i){return i.animId!==this._animId?e.Deferred().reject():(i.paused&&this.setFixedPosition(this.$el.offset().top),this._triggerAfterPageReveal(i))},_fetchPageModules:function(e,t){t.paused?t.modulePromise.resolve():t.resourcePromise.done(function(){d.fetchPageModules(e.js_modules).done(t.modulePromise.resolve)})},_insertAppMarkup:function(t,i){var s=e(".site-header");this.setElement(t,!1),t.hasClass("js-ab-app-el")||(t.hide(),this.$el.insertAfter(s)),i&&this.setFixedPosition(s.outerHeight())},changePage:function(e,t,i,s,n){var a=this._buildRequestInfo(e,t,i,s,n);return this.destroyModules(),i?this._handleChangePageRequest(i,a):this._handleChangePageNoRequest(a)},_handleChangePageNoRequest:function(e){return this._fetchPageModules(this.pageInfo,e),this._triggerAfterPageReveal(e)},_handleChangePageRequest:function(i,n){var a=this.animateChangePagePreData(n.fromUrl,n.toUrl);return a||this._triggerGenericLoader(i),i=i.then(t.bind(function(e){return this._triggerBeforePageReveal(e,n).then(function(){return e})},this)),e.when(i,a).then(t.bind(function(e){return n.paused||s.updateState(),this._finishChangePage(e,n)},this))},_triggerGenericLoader:function(e){"pending"===e.state()&&(this.activateLoader(),e.always(t.bind(function(){this.deactivateLoader()},this)))},_finishChangePage:function(i,s){if(s.animId!==this._animId)return e.Deferred().reject();var n=this.animateChangePagePostData(s.fromUrl,s.toUrl,i,s.paused)||e.Deferred().resolve();return s.paused&&this.setFixedPosition(this.$el.offset().top),n.then(t.bind(function(){return this._triggerAfterPageReveal(s)},this))},updateLayoutFlag:function(){if(!s.getPreloadedApp()){var e=r.get("body"),t=e.attr("data-layout")||"",i=this.pageInfo.layout_type||"";t!==i&&(t&&e.removeClass(t+"-layout"),i&&e.addClass(i+"-layout"),e.attr("data-layout",i))}},swapContent:function(t,i,s,n){return r.getNested(window.site_vars,"flags","disable_swap_fade")||this.isSafari5||this.isApple||s?(i.insertAfter(t),t.remove(),e.Deferred().resolve()):this._crossFade(t,i,n)},_crossFade:function(e,t,i){var s=parseInt(e.css("top"),10)||e.offset().top||0;return s-=r.getScrollPosition(),t.css({"z-index":100,overflow:"hidden"}),e.css({position:"absolute","z-index":101,opacity:1,top:s}),t.insertAfter(e),i&&this._scrollToHashTag(t,i)||a.scrollTop(0),this.animate(e,"opacity",0,this.options.animations.fadeIn.duration).always(function(){t.css({"z-index":"",overflow:""}),e.remove()})},_scrollToHashTag:function(e,t){var i=this._getOffset(e,t);return i.top?(this.$top.scrollTop(i.top-this.$el.offset().top),!0):void 0},_getOffset:function(e,t){try{return e.find("a[name="+t+"]").offset()||{}}catch(i){console.warn("Invalid hashtag",t)}return{}},pause:function(){this.destroyModules(!1,!0)},getHash:function(e){var t=e.indexOf("#");return-1!==t?e.substring(t+1):null},_triggerAfterPageReveal:function(i){return e.when(i.resourcePromise,i.modulePromise).done(t.bind(function(e,t){i.animId===this._animId&&(i.paused||(o.trigger("page:beforeLoad",this.pageInfo),this._initPage(null!==i.fromUrl,e,t)),this._safeCall("afterPageReveal",i.fromUrl,i.toUrl,i.paused,e&&e[0]),this.appRevealed=!0,this.currentPath=i.toUrl,i.paused||this.trackPageLoad(this.pageInfo),window.GidgitsJS&&window.GidgitsJS.refresh&&window.GidgitsJS.refresh())},this))},_safeCall:function(e){try{return this[e].apply(this,Array.prototype.slice.call(arguments,1))}catch(t){console.error("View threw an exception on "+e,t.stack||t.stacktrace||t.message)}},_initPage:function(e,t,i){e&&(this.delegateEvents(),this._updatePageTitle(),this.updateLayoutFlag()),t&&t.length>1?this._initModules(t[1].concat(i||[])):this._initModules(i)},_triggerBeforePageReveal:function(e,t){this._safeCall("beforePageReveal",t.fromUrl,t.toUrl,e,t.paused);var i=this._setPageInfo(e,t);return this._isCorrectApp(i.jsUrl)},_isCorrectApp:function(t){var i=this;return e.Deferred(function(e){if(t){var s=h.getInfo(t);if(s&&s.app.AppClass.prototype!==Object.getPrototypeOf(i))return void e.reject("InvalidApp",s)}e.resolve()})},_setPageInfo:function(e,t){var i;return i=t.fromUrl||t.paused?r.parsePageInfo(e):s.getActivePageInfo(),this.verifyPageInfo(i,t),this._fetchPageModules(i,t),t.requestPromise.ajaxPromise&&(i.headerAbVariant=t.requestPromise.ajaxPromise.getResponseHeader("X-AbVariant")),t.paused||o.trigger("activePageInfo:set",i),o.trigger("pageInfo:set",i),this.pageInfo=i,i},verifyPageInfo:function(e,t){return e.templatetype=e.templatetype||"",e.ssts=e.ssts||"bugpages",e.cst=e.aws||e.cst||"undefined",e.routePath=e.routePath||t.toUrl,e},_updatePageTitle:function(){if("None"===(this.pageInfo.seotitle||"None")){var e=r.getNested(window.site_vars,"display_name");e&&(document.title=e)}else document.title=this.pageInfo.seotitle},removeApp:function(e,i){return this._animId++,this._safeCall("beforeAppRemove",e,i),this.destroyModules(!1),this._triggerAnimateRemoveApp(e,i).always(t.bind(function(){this._safeCall("afterAppRemove",e,i),this._safeDestroy()},this))},_triggerAnimateRemoveApp:function(t,i){var s=this._safeCall("animateRemoveApp",t,i);return s?n.addAnimation(s):e.Deferred().resolve()},_safeDestroy:function(){try{this.destroy(!0)}catch(e){console.error("View threw an exception on destroy: ",e.stack||e.stacktrace||e.message),this.$el.remove()}},getWindowOffset:function(){return this.el?this.el.getBoundingClientRect():{top:0,left:0}},animateRevealApp:function(t,i,s){return this.isApple&&s?e.Deferred().resolve():this.show(!0)},animateRemoveApp:function(e,t){return this.hide(!0)},animateChangePagePreData:function(e,t){return null},animateChangePagePostData:function(e,t,i,s){var n=this.swapContent(this.$el,i,s,this.getHash(t));return this.setElement(i,!1),n},setFixedPosition:function(e,t){t||!this.isSafari5&&!this.isApple?(this._header=a.getHeader(),this._header?this._header.isFixed()?(this._header.isOpen()?this._fixedOffset=e-this._header.getFixedThreshold():this._fixedOffset=e,this.$el.css({position:"fixed",top:e})):(this._fixedOffset=e=this.$el.offset().top,this.$el.css({position:"absolute",top:e})):this._fixedOffset=e):this.$el.hide()},clearFixedPosition:function(e){this._fixedOffset=null,e||!this.isSafari5&&!this.isApple?this.$el.css({position:"",top:""}):this.$el.show()},_onHeaderFixed:function(){this._header&&null!==this._fixedOffset&&(this._fixedOffset-=this._header.getFixedThreshold(),this.$el.css({position:"fixed",top:this._fixedOffset}))},_onHeaderUnfixed:function(){this._header&&null!==this._fixedOffset&&(this._fixedOffset+=this._header.getFixedThreshold(),this.$el.css({position:"absolute",top:this._fixedOffset}))},activateLoader:function(){},deactivateLoader:function(){},beforeAppRemove:function(e,t){},afterAppRemove:function(e,t){},beforePageReveal:function(e,t,i,s){},afterPageReveal:function(e,t,i,s){s&&(this.subviews.page=new s({el:this.$el}))},getRevealAppLoader:function(e){return'<section class="ui-loading dark-medium ui-app-loader"></section>'},beforeOverlayRemove:function(e){},afterOverlayReveal:function(e){},afterLoaderReveal:function(){},beforeLoaderRemove:function(){},getClientAdInfo:function(){return{}},parsePageInfo:function(e){return s.parsePageInfo(e)},getClientInfo:function(){return{}},trackPageLoad:function(e){var i=r.getNested(window.site_vars,"flags","traffic_cop_defer");i?o.trigger("page:load",e):t.defer(function(){n.getAnimationCompletion().done(function(){o.trigger("page:load",e)})})},buildModules:function(e){return d.fetchPageModules(e).done(t.bind(this._initModules,this))},_initModules:function(e){this.destroyed||t.each(e,this._initModule,this)},_initModule:function(e){var i=e.selector,s=this.seenModules[e.name]||0;e.position&&(i="#module-position-"+e.position+i+",#module-position-"+e.position+" "+i),this.$(i).each(t.bind(function(t,i){if(-1!==i.className.indexOf("companion-galleries"))return!1;try{this.subviews[e.name+s]=new e.ModuleClass(this._getModuleOptions(i,e))}catch(n){console.error("failed loading module "+e.name,n.stack||n.stacktrace||n.message)}s+=1},this)),this.seenModules[e.name]=s},_getModuleOptions:function(i,s){var n=e(i).attr("data-options-id")||"default",a=t.findWhere(r.getNested(window.site_vars,"moduleOptions"),{moduleName:s.name}),o=t.find(r.getNested(a,"optionSets"),function(e){return e.id===n})||{},d=f.getUserTestByTarget(s.name),h=r.getNested(d,"userVariant","options")||{},u=t.extend({},o,s.options,h);return d&&(u.abTest=d),u.el=i,u.layoutType=s.layoutType,u}});return u});
//# sourceMappingURL=base-app.js.map